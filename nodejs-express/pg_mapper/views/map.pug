extends layout
block content

    #map
    script.


        //Array that will save all the layers
        var layerArray = [];
        
        
        
        var map = L.map('map',{preferCanvas: true,renderer: L.canvas({}), center: [39.96964,116.33251], zoom: 10});
        map.createPane('lensPane');
        map.createPane('outtterLensPane');
        map.createPane('outtterLensDeletePane');
        map.createPane('velPane');
        map.createPane('attLensPane');
        map.createPane('queryLensPane');
        map.createPane('queryLensPane1');
        map.createPane('queryLensPane2');
        map.createPane('queryLensPane3');
        map.getPane('lensPane').style.zIndex = 600;
        map.getPane('outtterLensPane').style.zIndex = 650;
        map.getPane('outtterLensDeletePane').style.zIndex = 700;
        map.getPane('attLensPane').style.zIndex = 450;
        map.getPane('queryLensPane').style.zIndex = 400;
        map.getPane('queryLensPane1').style.zIndex = 401;
        map.getPane('queryLensPane2').style.zIndex = 402;
        map.getPane('queryLensPane3').style.zIndex = 403;
        map.getPane('velPane').style.zIndex = 400;
        var popup = L.popup();
        var popup2 = L.popup();

        var minValueVel;
        var maxValueVel;
        var minValueLength;
        var maxValueLength;
        var minValueTime;
        var maxValueTime;
        var minValueTimeDuration;
        var maxValueTimeDuration;

        //create array with all layers?

        var markerGroup  = L.featureGroup({pane: 'queryLensPane'}).addTo(map);
        var markerGroup1 = L.featureGroup({pane: 'queryLensPane1'}).addTo(map);
        var markerGroup2 = L.featureGroup({pane: 'queryLensPane2'}).addTo(map);
        var markerGroup3 = L.featureGroup({pane: 'queryLensPane3'}).addTo(map);
        
        var attLenResults = L.featureGroup({pane: 'attLensPane'}).addTo(map);

        var outterLensesLayer = L.featureGroup({pane: 'outtterLensPane'}).addTo(map);
        var lensesLayer = L.featureGroup({pane: 'lensPane'}).addTo(map);
        

        var lensPreCreationLayer = L.layerGroup().addTo(map);
        
        var lastMarkerGroupID = null ;
        var lastMarkerGroupID1 = null ;
        var lastMarkerGroupID2 = null ;
        var lastMarkerGroupID3 = null ;
        var defaultLayerFlag = true;

        var createQueryLensesFlag = false;
        var createAttributeLensesFlag = false;

        var attributeFuncVar = "length";
        var encodingFuncVar = "color";

        var attLensesArray = [];


        //black and white, when it is a greyish color its hard to see
        /*L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}{r}.{ext}', {
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            subdomains: 'abcd',
            minZoom: 2,
            maxZoom: 25,
            ext: 'png'
        }).addTo(map);*/

        //Terrain is coloured, colors sometimes hard to see
       /* L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.{ext}', {
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            subdomains: 'abcd',
            minZoom: 0,
            maxZoom: 18,
            ext: 'png'
        }).addTo(map);*/

        //ALL black and dark grey
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        //var myData = jsonData;
        var myData = !{JSON.stringify(jsonData)};

        // Create variable to hold map element, give initial settings to map
        var customControlQ =  L.Control.extend({

        options: {
            position: 'topleft'
        },

        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');

            container.style.backgroundColor = 'white';     
            container.style.backgroundImage = "url(images/636051.svg)";
            container.style.backgroundSize = "30px 30px";
            container.style.width = '30px';
            container.style.height = '30px';

            container.onclick = function(e){
                L.DomEvent.stopPropagation(e); 
                if(!createAttributeLensesFlag){
                    createQueryLensesFlag = !createQueryLensesFlag;
                    if (createQueryLensesFlag){
                        container.style.backgroundColor = 'grey';
                    }
                    else{
                        container.style.backgroundColor = 'white';   
                    }
                }
            }

            return container;
        }
        });
        var customControlA =  L.Control.extend({

        options: {
            position: 'topleft'
        },

        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');

            container.style.backgroundColor = 'white';     
            //container.style.backgroundImage = "url(images/636051.svg)";
            container.style.backgroundSize = "30px 30px";
            container.style.width = '30px';
            container.style.height = '30px';

            container.onclick = function(e){
                L.DomEvent.stopPropagation(e); 
                if(!createQueryLensesFlag){
                    createAttributeLensesFlag = !createAttributeLensesFlag;
                    if (createAttributeLensesFlag){
                        container.style.backgroundColor = 'grey';
                    }
                    else{
                        container.style.backgroundColor = 'white';   
                    }
                }
            }

            return container;
        }
        });

        map.addControl(new customControlQ());
        map.addControl(new customControlA());
            
        var container = document.getElementsByClassName("leaflet-zoom-animated");
        container[0].onclick = function(e){
                L.DomEvent.stopPropagation(e);
        }
                

        
        //var defaultLayer = new L.GeoJSON().addTo(map);
        var firstStyle = {
            "color": '#FF6347',
            "weight": 1.5
            
        };
        var firstStyleATT = {
            "color": '#FF6347',
            "weight": 1.5,
            "pane": "attLensPane"
            
        };
        /*var color2;
            var r = Math.min(Math.max(Math.floor(Math.random() * 255), 55), 200);
            var g = Math.min(Math.max(Math.floor(Math.random() * 255), 75), 255);
            var b = Math.min(Math.max(Math.floor(Math.random() * 255), 100), 225);
            color2= "rgb("+r+" ,"+g+","+ b+")"; 

            

            var individualStyle = {
                "color": color2,
                "weight": 2,
                "opacity": 0.5
            };*/

     
        // Add JSON to map
        
        var defaultLayer = new L.geoJson(myData,firstStyle).addTo(map);
    
        map.on('zoomend', function() {
            console.log(map.getZoom())
            if (map.getZoom() >= 19){
                    markerGroup3.addTo(map);
            }
            else {
                if (map.hasLayer(markerGroup3)) {
                    map.removeLayer(markerGroup3);
                } else {
                    console.log("MarkerGroup3 not active");
                }
                if (map.getZoom() >= 17){
                    markerGroup2.addTo(map);
                }
                else {
                    if (map.hasLayer(markerGroup2)) {
                        map.removeLayer(markerGroup2);
                    } else {
                        console.log("MarkerGroup2 not active");
                    }
                    if (map.getZoom() >= 15){
                        markerGroup1.addTo(map);
                    }
                    else {
                        if (map.hasLayer(markerGroup1)) {
                            map.removeLayer(markerGroup1);
                        } else {
                            console.log("MarkerGroup1 not active");
                        }
                
                    }
                }
            }
            lensesLayer.bringToFront();
        });   
            

        function onMapClick(e) {// + "<input id='radiusBox' type='text' size='20'/>"
            if(createQueryLensesFlag){   
                queryLensMenu(e);
            }
            else if(createAttributeLensesFlag){
                attributeLensMenu(e);
            }
        }

        map.on('click', onMapClick);

       

        /*function createQuery(lng, lat, radiusQuery, typeLens, minVal, maxVal){
            lensPreCreationLayer.clearLayers();
            console.log("Im removing the map now and adding new ones afterwards")
            if(defaultLayerFlag){
                defaultLayerFlag = false;
                map.removeLayer(defaultLayer);
            }

            if(lastMarkerGroupID !=null){
                markerGroup.removeLayer(lastMarkerGroupID);
                lastMarkerGroupID = null;
            }
            if(lastMarkerGroupID1 !=null){
                markerGroup1.removeLayer(lastMarkerGroupID1);
                lastMarkerGroupID1 = null;
            }
            if(lastMarkerGroupID2 !=null){
                markerGroup2.removeLayer(lastMarkerGroupID2);
                lastMarkerGroupID2 = null;
            }
            if(lastMarkerGroupID3 !=null){
                markerGroup3.removeLayer(lastMarkerGroupID3);
                lastMarkerGroupID3 = null;
            }

                // Create URL
            var urlString3 = "query/trajectory_lines/"  + lng + "/" + lat + "/" + radiusQuery + "/" + typeLens + "/" + minVal + "/" + maxVal;
            var urlString2 = "query/trajectory_lines1/" + lng + "/" + lat + "/" + radiusQuery + "/" + typeLens + "/" + minVal + "/" + maxVal;
            var urlString1 = "query/trajectory_lines2/" + lng + "/" + lat + "/" + radiusQuery + "/" + typeLens + "/" + minVal + "/" + maxVal;
            var urlString  = "query/trajectory_lines3/" + lng + "/" + lat + "/" + radiusQuery + "/" + typeLens + "/" + minVal + "/" + maxVal;
            
            var lensesVar = createLens(lng, lat, radiusQuery, typeLens, minVal, maxVal);
            
            var newData = $.ajax({
                url: urlString,
                type: 'GET',
                dataType:'json',
                success: console.log("Data successfully loaded!"),
                error: function (xhr) {
                    alert(xhr.statusText)
                }
                
            }) 
            $.when(newData).done(function() {
                
                if(newData.responseJSON.features != null){
                    var tracksToDraw = L.geoJson(newData.responseJSON,firstStyle);
                    tracksToDraw.addTo(markerGroup);
                    lastMarkerGroupID = tracksToDraw._leaflet_id;
                    lensesVar.colorSuccess();
                }
                lensesLayer.bringToFront();
            }); 
            var newData1 = $.ajax({
                url: urlString1,
                type: 'GET',
                dataType:'json',
                success: console.log("Data successfully loaded!"),
                error: function (xhr) {
                    alert(xhr.statusText)
                }
                
            }) 
            $.when(newData1).done(function() {
                if(newData1.responseJSON.features != null){
                    var tracksToDraw = L.geoJson(newData1.responseJSON,firstStyle);
                    tracksToDraw.addTo(markerGroup1);
                    lastMarkerGroupID1 = tracksToDraw._leaflet_id;
                    lensesVar.colorSuccess();
                }
                lensesLayer.bringToFront();
            });
            var newData2 = $.ajax({
                url: urlString2,
                type: 'GET',
                dataType:'json',
                success: console.log("Data successfully loaded!"),
                error: function (xhr) {
                    alert(xhr.statusText)
                }
                
            }) 
            $.when(newData2).done(function() {
                if(newData2.responseJSON.features != null){
                    var tracksToDraw = L.geoJson(newData2.responseJSON,firstStyle);
                    tracksToDraw.addTo(markerGroup2);
                    lastMarkerGroupID2 = tracksToDraw._leaflet_id;
                    lensesVar.colorSuccess();
                }
                lensesLayer.bringToFront();
            });
            var newData3 = $.ajax({
                url: urlString3,
                type: 'GET',
                dataType:'json',
                success: console.log("Data successfully loaded!"),
                error: function (xhr) {
                    alert(xhr.statusText)
                }
                
            }) 
            $.when(newData3).done(function() {
                if(newData3.responseJSON.features != null){
                    var tracksToDraw = L.geoJson(newData3.responseJSON,firstStyle);
                    tracksToDraw.addTo(markerGroup3);
                    lastMarkerGroupID3 = tracksToDraw._leaflet_id;
                    lensesVar.colorSuccess();
                }
                lensesLayer.bringToFront();
            });
            
            attLensesArray.forEach(function(item, index, array) {
                item.updateALL();
            });
        }*/
        
        /*function createAttributeQuery(lngLat, radiusQuery, aTypeLens, encoding){
            var attLayer = L.featureGroup().addTo(attLenResults);
            var _attLayer = L.featureGroup().addTo(attLayer);
            var _attLayer1 = L.featureGroup().addTo(attLayer);
            var _attLayer2 = L.featureGroup().addTo(attLayer);
            var _attLayer3 = L.featureGroup().addTo(attLayer);
            
                // Create URL
            var urlString3 = "attQuery/trajectory_lines/"  + lngLat.lng + "/" + lngLat.lat + "/" + radiusQuery;
            var urlString2 = "attQuery/trajectory_lines1/" + lngLat.lng + "/" + lngLat.lat + "/" + radiusQuery;
            var urlString1 = "attQuery/trajectory_lines2/" + lngLat.lng + "/" + lngLat.lat + "/" + radiusQuery;
            var urlString  = "attQuery/trajectory_lines3/" + lngLat.lng + "/" + lngLat.lat + "/" + radiusQuery;
            
            var lensesVar = createALens(lngLat, radiusQuery, aTypeLens, encoding);
            lensesVar.lID = attLayer._leaflet_id;
            var newData = $.ajax({
                url: urlString,
                type: 'GET',
                dataType:'json',
                success: console.log("Data successfully loaded!"),
                error: function (xhr) {
                    alert(xhr.statusText)
                }
                
            }) 
            $.when(newData).done(function() {
                
                if(newData.responseJSON.features != null){
                    console.log(newData.responseJSON.features);
                    newData.responseJSON.features.forEach(function(item, index, array) {
                        var tracksToDraw = L.geoJson(item,firstStyle);
                        switch(aTypeLens) {
                            case "length":
                                lengthAtt(tracksToDraw, item.properties, encoding);
                                break;
                            case "duration":
                                // code block
                                durationAtt(tracksToDraw, item.properties, encoding);
                                break;
                            case "vel":
                                velocityAtt(tracksToDraw, item.properties, encoding);
                                break;
                            case "time":
                                timeAtt(tracksToDraw, item.properties, encoding);
                                break;
                        } 
                        lensesVar.intersections.forEach(function(lensInt, index, array) {
                            if(lensInt.areaQuery.getBounds().intersects(tracksToDraw.getBounds())){
                                console.log("This layer intersects the other lenses");
                                console.log(lensInt.areaQuery.getBounds().intersects(tracksToDraw.getBounds()));
                                console.log(lensInt);
                                console.log(tracksToDraw);
                                lensInt.updateLayer(tracksToDraw,item.properties)
                            }
                        });
                        tracksToDraw.addTo(_attLayer);
                    });
                    
                }
            }); 
            var newData1 = $.ajax({
                url: urlString1,
                type: 'GET',
                dataType:'json',
                success: console.log("Data successfully loaded!"),
                error: function (xhr) {
                    alert(xhr.statusText)
                }
                
            }) 
            $.when(newData1).done(function() {
                if(newData1.responseJSON.features != null){
                    console.log(newData1.responseJSON.features);
                    newData1.responseJSON.features.forEach(function(item, index, array) {
                        var tracksToDraw = L.geoJson(item,firstStyle);
                        switch(aTypeLens) {
                            case "length":
                                lengthAtt(tracksToDraw, item.properties, encoding);
                                break;
                            case "duration":
                                // code block
                                durationAtt(tracksToDraw, item.properties, encoding);
                                break;
                            case "vel":
                                velocityAtt(tracksToDraw, item.properties, encoding);
                                break;
                            case "time":
                                timeAtt(tracksToDraw, item.properties, encoding);
                                break;
                        } 
                        lensesVar.intersections.forEach(function(lensInt, index, array) {
                            console.log(lensInt, index);
                            if(lensInt.areaQuery.getBounds().intersects(tracksToDraw.getBounds())){
                                lensInt.updateLayer(tracksToDraw,item.properties)
                            }
                        });
                        tracksToDraw.addTo(_attLayer1);
                    });
                    
                }
            });
            var newData2 = $.ajax({
                url: urlString2,
                type: 'GET',
                dataType:'json',
                success: console.log("Data successfully loaded!"),
                error: function (xhr) {
                    alert(xhr.statusText)
                }
                
            }) 
            $.when(newData2).done(function() {
                if(newData2.responseJSON.features != null){
                    console.log(newData2.responseJSON.features);
                    newData2.responseJSON.features.forEach(function(item, index, array) {
                        var tracksToDraw = L.geoJson(item,firstStyle);
                        switch(aTypeLens) {
                            case "length":
                                lengthAtt(tracksToDraw, item.properties, encoding);
                                break;
                            case "duration":
                                // code block
                                durationAtt(tracksToDraw, item.properties, encoding);
                                break;
                            case "vel":
                                velocityAtt(tracksToDraw, item.properties, encoding);
                                break;
                            case "time":
                                timeAtt(tracksToDraw, item.properties, encoding);
                                break;
                        } 
                        lensesVar.intersections.forEach(function(lensInt, index, array) {
                            console.log(lensInt, index);
                            if(lensInt.areaQuery.getBounds().intersects(tracksToDraw.getBounds())){
                                lensInt.updateLayer(tracksToDraw,item.properties)
                            }
                        });
                        tracksToDraw.addTo(_attLayer2);
                    });
                    
                }
            });
            var newData3 = $.ajax({
                url: urlString3,
                type: 'GET',
                dataType:'json',
                success: console.log("Data successfully loaded!"),
                error: function (xhr) {
                    alert(xhr.statusText)
                }
                
            }) 
            $.when(newData3).done(function() {
                if(newData3.responseJSON.features != null){
                    console.log(newData3.responseJSON.features);
                    newData3.responseJSON.features.forEach(function(item, index, array) {
                        var tracksToDraw = L.geoJson(item,firstStyle);
                        switch(aTypeLens) {
                            case "length":
                                lengthAtt(tracksToDraw, item.properties, encoding);
                                break;
                            case "duration":
                                // code block
                                durationAtt(tracksToDraw, item.properties, encoding);
                                break;
                            case "vel":
                                velocityAtt(tracksToDraw, item.properties, encoding);
                                break;
                            case "time":
                                timeAtt(tracksToDraw, item.properties, encoding);
                                break;
                        } 
                        lensesVar.intersections.forEach(function(lensInt, index, array) {
                            console.log(lensInt, index);
                            if(lensInt.areaQuery.getBounds().intersects(tracksToDraw.getBounds())){
                                lensInt.updateLayer(tracksToDraw,item.properties)
                            }
                        });
                        tracksToDraw.addTo(_attLayer3);
                    });
                    
                    lensesVar.colorSuccess();
                }
            });
            lensesVar.colorSuccess();
            
        }*/



        /*function attributeLensCreation(lngLat,radius,attribute,encoding){
            var metresPerPixel = 40075016.686 * Math.abs(Math.cos(lngLat.lat * 180/Math.PI)) / Math.pow(2, map.getZoom()+8);
            var pixelsInRadius = radius / metresPerPixel;
            var aLens = createALens(lngLat, radius, attribute, encoding);
            var layerToPaintVEL = L.featureGroup().addTo(attLenResults);

            if(defaultLayerFlag){
                defaultLayer.eachLayer(function (layer) {
                    var yourDistance = L.GeometryUtil.closest(map, layer, lngLat).distance;
                    //var layersActive = layersWithin(map, layer, lngLat, pixelsInRadius)
                    if ( yourDistance <= pixelsInRadius){
                        switch(attribute) {
                            case "length":
                                lengthAtt(layer, encoding);
                                break;
                            case "duration":
                                // code block
                                durationAtt(layer, encoding);
                                break;
                            case "vel":
                                velocityAtt(layerToPaintVEL,layer,encoding);
                                break;
                            case "time":
                                timeAtt(layer, encoding);
                                break;
                        }   
                        
                    //}
                    }
                
                });
            }
            else{
                 if(lastMarkerGroupID !=null ){
                    markerGroup.getLayer(lastMarkerGroupID).eachLayer(function (layer) {
                        var yourDistance = L.GeometryUtil.closest(map, layer, lngLat).distance;
                        //var layersActive = layersWithin(map, layer, lngLat, pixelsInRadius)
                        if ( yourDistance <= pixelsInRadius){
                            switch(attribute) {
                                case "length":
                                    lengthAtt(layer, encoding);
                                    break;
                                case "duration":
                                    // code block
                                    durationAtt(layer, encoding);
                                    break;
                                case "vel":
                                    velocityAtt(layerToPaintVEL,layer,encoding);
                                    break;
                                case "time":
                                    timeAtt(layer, encoding);
                                    break;
                            }   
                            
                        //}
                        }
                        
                    });
                }
                if(lastMarkerGroupID1 !=null && map.hasLayer(markerGroup1)){
                    markerGroup1.getLayer(lastMarkerGroupID1).eachLayer(function (layer) {
                        var yourDistance = L.GeometryUtil.closest(map, layer, lngLat).distance;
                        //var layersActive = layersWithin(map, layer, lngLat, pixelsInRadius)
                        if ( yourDistance <= pixelsInRadius){
                            switch(attribute) {
                                case "length":
                                    lengthAtt(layer, encoding);
                                    break;
                                case "duration":
                                    // code block
                                    durationAtt(layer, encoding);
                                    break;
                                case "vel":
                                    velocityAtt(layerToPaintVEL,layer,encoding);
                                    break;
                                case "time":
                                    timeAtt(layer, encoding);
                                    break;
                            }   
                            
                        //}
                        }
                    
                    });          
                }
                if(lastMarkerGroupID2 !=null && map.hasLayer(markerGroup2)){
                    markerGroup2.getLayer(lastMarkerGroupID2).eachLayer(function (layer) {
                        var yourDistance = L.GeometryUtil.closest(map, layer, lngLat).distance;
                        //var layersActive = layersWithin(map, layer, lngLat, pixelsInRadius)
                        if ( yourDistance <= pixelsInRadius){
                            switch(attribute) {
                                case "length":
                                    lengthAtt(layer, encoding);
                                    break;
                                case "duration":
                                    // code block
                                    durationAtt(layer, encoding);
                                    break;
                                case "vel":
                                    velocityAtt(layerToPaintVEL,layer,encoding);
                                    break;
                                case "time":
                                    timeAtt(layer, encoding);
                                    break;
                            }   
                            
                        //}
                        }
                        
                    });   
                }
                if(lastMarkerGroupID3 !=null && map.hasLayer(markerGroup3)){
                    markerGroup3.getLayer(lastMarkerGroupID3).eachLayer(function (layer) {
                        var yourDistance = L.GeometryUtil.closest(map, layer, lngLat).distance;
                        //var layersActive = layersWithin(map, layer, lngLat, pixelsInRadius)
                        if ( yourDistance <= pixelsInRadius){
                            switch(attribute) {
                                case "length":
                                    lengthAtt(layer, encoding);
                                    break;
                                case "duration":
                                    // code block
                                    durationAtt(layer, encoding);
                                    break;
                                case "vel":
                                    velocityAtt(layerToPaintVEL,layer,encoding);
                                    break;
                                case "time":
                                    timeAtt(layer, encoding);
                                    break;
                            }   
                            
                        //}
                        }
                        
                    });
                }
            
            }
            aLens.colorSuccess();
            if(attribute == "vel" && encoding == "color"){
                aLens.lID = layerToPaintVEL._leaflet_id;
            }
            console.log("lensesLayer now");
            lensesLayer.bringToFront();
        }*/

        /////
        /////
        /////

        /////
        /////
        /////

        /*function deleteQuery(lng, lat, radius, type, minVal, maxVal){
            var urlString3 = "queryRemoval/trajectory_lines/"  + lng + "/" + lat + "/" + radius + "/" + type + "/" + minVal + "/" + maxVal;
            var urlString2 = "queryRemoval/trajectory_lines1/" + lng + "/" + lat + "/" + radius + "/" + type + "/" + minVal + "/" + maxVal;
            var urlString1 = "queryRemoval/trajectory_lines2/" + lng + "/" + lat + "/" + radius + "/" + type + "/" + minVal + "/" + maxVal;
            var urlString  = "queryRemoval/trajectory_lines3/" + lng + "/" + lat + "/" + radius + "/" + type + "/" + minVal + "/" + maxVal;

            var newData = $.ajax({
                url: urlString,
                type: 'GET',
                dataType:'json',
                success: console.log("1 successfully loaded!"),
                error: function (xhr) {
                    alert(xhr.statusText)
                }
                
            })
            $.when(newData).done(function() {
                
                console.log("Im removing the map now and adding new ones afterwards")
                
                if(newData.responseJSON.features != null){
                    var tracksToDraw = L.geoJson(newData.responseJSON,firstStyle);
                    tracksToDraw.addTo(markerGroup);
                    var idTracks = tracksToDraw._leaflet_id;
                    lastMarkerGroupID = tracksToDraw._leaflet_id;
                    
                }
                lensesLayer.bringToFront();
                
            });
            var newData1 = $.ajax({
                url: urlString1,
                type: 'GET',
                dataType:'json',
                success: console.log("2 successfully loaded!"),
                error: function (xhr) {
                    alert(xhr.statusText)
                }
                
            })
            $.when(newData1).done(function() {
                
                console.log("Im removing the map now and adding new ones afterwards")
                
                if(newData1.responseJSON.features != null){
                    var tracksToDraw = L.geoJson(newData1.responseJSON,firstStyle);
                    tracksToDraw.addTo(markerGroup1);
                    lastMarkerGroupID1 = tracksToDraw._leaflet_id;
                    
                }
                lensesLayer.bringToFront();
            });
            var newData2 = $.ajax({
                url: urlString2,
                type: 'GET',
                dataType:'json',
                success: console.log("3 successfully loaded!"),
                error: function (xhr) {
                    alert(xhr.statusText)
                }
                
            })
            $.when(newData2).done(function() {
                
                console.log("Im removing the map now and adding new ones afterwards")
                
                if(newData2.responseJSON.features != null){
                    var tracksToDraw = L.geoJson(newData2.responseJSON,firstStyle);
                    tracksToDraw.addTo(markerGroup2);
                    lastMarkerGroupID2 = tracksToDraw._leaflet_id;
                     
                }
                lensesLayer.bringToFront();
            });
            var newData3 = $.ajax({
                url: urlString3,
                type: 'GET',
                dataType:'json',
                success: console.log("4 successfully loaded!"),
                error: function (xhr) {
                    alert(xhr.statusText)
                }
                
            })
            $.when(newData3).done(function() {
                
                console.log("Im removing the map now and adding new ones afterwards")
                
                if(newData3.responseJSON.features != null){
                    var tracksToDraw = L.geoJson(newData3.responseJSON,firstStyle);
                    tracksToDraw.addTo(markerGroup3);
                    lastMarkerGroupID3 = tracksToDraw._leaflet_id;
                     
                }
                lensesLayer.bringToFront();
            });
            
        }*/

        /*function deleteAttribute(lngLat, radius, _attribute, _encoding){
            console.log("Delete att");
            var metresPerPixel = 40075016.686 * Math.abs(Math.cos(lngLat.lat * 180/Math.PI)) / Math.pow(2, map.getZoom()+8);
            var pixelsInRadius = radius / metresPerPixel;
            if(defaultLayerFlag){
                    defaultLayer.eachLayer(function (layer) {
                        console.log("Each layer");
                        var yourDistance = L.GeometryUtil.closest(map, layer, lngLat).distance;
                        //var layersActive = layersWithin(map, layer, lngLat, pixelsInRadius)
                        if ( yourDistance <= pixelsInRadius){
                            switch(_encoding) {
                                case "color":
                                    layer.setStyle({color: '#FF6347'});
                                    layer.setStyle({opacity:1.0});
                                        attLensesArray.forEach(function(item, index, array) {
                                            console.log(item, index);
                                            if(item.att == "vel"){ //if same type dont perform? detetar layers em conjunto, guardar valor em array d layers por lente e dps apagar.
                                                var layerToPaint = L.featureGroup().addTo(attLenResults);
                                                item.updateLayer(layer, layerToPaint);
                                            }
                                            else item.updateLayer(layer, null)
                                        });
                                    break;
                                case "brightness":
                                    layer.setStyle({color: '#FF6347'});
                                    attLensesArray.forEach(function(item, index, array) {
                                        console.log(item, index);
                                        item.updateLayer(layer)
                                    });
                                    break;
                                case "opacity":
                                    console.log("Returning Opacity to 1");
                                    layer.setStyle({opacity:1});
                                    break;
                                case "width":
                                    console.log("Returning Width to 1.5");
                                    layer.setStyle({"weight": 1.5});
                                    break;
                            }
                        }               
                    });
            }
            else{
                if(lastMarkerGroupID3 !=null && map.hasLayer(markerGroup3)){
                    markerGroup3.getLayer(lastMarkerGroupID3).eachLayer(function (layer) {
                        console.log("Each layer");
                        var yourDistance = L.GeometryUtil.closest(map, layer, lngLat).distance;
                        //var layersActive = layersWithin(map, layer, lngLat, pixelsInRadius)
                        if ( yourDistance <= pixelsInRadius){
                            switch(_encoding) {
                                case "color":
                                    layer.setStyle({color: '#FF6347'});
                                    layer.setStyle({opacity:1.0});
                                        attLensesArray.forEach(function(item, index, array) {
                                            console.log(item, index);
                                            if(item.att == "vel"){
                                                var layerToPaint = L.featureGroup().addTo(attLenResults);
                                                item.updateLayer(layer, layerToPaint);
                                            }
                                            else item.updateLayer(layer, null)
                                        });
                                    break;
                                case "brightness":
                                    layer.setStyle({color: '#FF6347'});
                                    attLensesArray.forEach(function(item, index, array) {
                                        console.log(item, index);
                                        item.updateLayer(layer)
                                    });
                                    break;
                                case "opacity":
                                    console.log("Returning Opacity to 1");
                                    layer.setStyle({opacity:1});
                                    break;
                                case "width":
                                    console.log("Returning Width to 1.5");
                                    layer.setStyle({"weight": 1.5});
                                    break;
                            }
                        }               
                    });
                }
                if(lastMarkerGroupID2 !=null && map.hasLayer(markerGroup2)){
                        markerGroup2.getLayer(lastMarkerGroupID2).eachLayer(function (layer) {
                            var yourDistance = L.GeometryUtil.closest(map, layer, lngLat).distance;
                            //var layersActive = layersWithin(map, layer, lngLat, pixelsInRadius)
                            if ( yourDistance <= pixelsInRadius){
                                switch(_encoding) {
                                    case "color":
                                        layer.setStyle({color: '#FF6347'});
                                        layer.setStyle({opacity:1.0});
                                        attLensesArray.forEach(function(item, index, array) {
                                            console.log(item, index);
                                            if(item.att == "vel"){
                                                var layerToPaint = L.featureGroup().addTo(attLenResults);
                                                item.updateLayer(layer, layerToPaint);
                                            }
                                            else item.updateLayer(layer, null)
                                        });
                                        break;
                                    case "brightness":
                                        layer.setStyle({color: '#FF6347'});
                                        attLensesArray.forEach(function(item, index, array) {
                                            console.log(item, index);
                                            item.updateLayer(layer)
                                        });
                                        break;
                                    case "opacity":
                                        layer.setStyle({opacity:1});
                                        break;
                                    case "width":
                                        layer.setStyle({"weight": 1.5});
                                        break;
                                }
                            }               
                        });
                }
                if(lastMarkerGroupID1 !=null && map.hasLayer(markerGroup1)){
                        markerGroup1.getLayer(lastMarkerGroupID1).eachLayer(function (layer) {
                            var yourDistance = L.GeometryUtil.closest(map, layer, lngLat).distance;
                            //var layersActive = layersWithin(map, layer, lngLat, pixelsInRadius)
                            if ( yourDistance <= pixelsInRadius){
                                switch(_encoding) {
                                    case "color":
                                        layer.setStyle({color: '#FF6347'});
                                        layer.setStyle({opacity:1.0});
                                        attLensesArray.forEach(function(item, index, array) {
                                            console.log(item, index);
                                            if(item.att == "vel"){
                                                var layerToPaint = L.featureGroup().addTo(attLenResults);
                                                item.updateLayer(layer, layerToPaint);
                                            }
                                            else item.updateLayer(layer, null)
                                        });
                                        break;
                                    case "brightness":
                                        layer.setStyle({color: '#FF6347'});
                                        attLensesArray.forEach(function(item, index, array) {
                                            console.log(item, index);
                                            item.updateLayer(layer)
                                        });
                                        break;
                                    case "opacity":
                                        layer.setStyle({opacity:1});
                                        break;
                                    case "width":
                                        layer.setStyle({"weight": 1.5});
                                        break;
                                }
                            }               
                        });
                }
                if(lastMarkerGroupID !=null && map.hasLayer(markerGroup)){
                        markerGroup.getLayer(lastMarkerGroupID).eachLayer(function (layer) {
                            var yourDistance = L.GeometryUtil.closest(map, layer, lngLat).distance;
                            //var layersActive = layersWithin(map, layer, lngLat, pixelsInRadius)
                            if ( yourDistance <= pixelsInRadius){
                                switch(_encoding) {
                                    case "color":
                                        layer.setStyle({color: '#FF6347'});
                                        layer.setStyle({opacity:1.0});
                                        attLensesArray.forEach(function(item, index, array) {
                                            console.log(item, index);
                                            if(item.att == "vel"){
                                                var layerToPaint = L.featureGroup().addTo(attLenResults);
                                                item.updateLayer(layer, layerToPaint);
                                            }
                                            else item.updateLayer(layer, null)
                                        });
                                        break;
                                    case "brightness":
                                        layer.setStyle({color: '#FF6347'});
                                        attLensesArray.forEach(function(item, index, array) {
                                            console.log(item, index);
                                            item.updateLayer(layer)
                                        });
                                        break;
                                    case "opacity":
                                        layer.setStyle({opacity:1.0});
                                        break;
                                    case "width":
                                        layer.setStyle({"weight": 1.5});
                                        break;
                                }
                            }               
                        });
                } 
            } 
        }*/

        /////
        /////
        /////

        
        /////
        ///// Menus for lens creation
        /////

        function queryLensMenu(e){
            lensPreCreationLayer.clearLayers();
            var location= e.latlng;
            createLens(location.lng, location.lat, 1000,"Default",0,0).createLayers();
            /*var previewCircle = L.circle(e.latlng, {
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.5,
                    radius: 5000
                });
            previewCircle.addTo(lensPreCreationLayer);
            popup
                .setLatLng(e.latlng)
                .setContent("You clicked the map at " + e.latlng.toString() + 
                "<input id='radiusBox' type='range' min='1' max='10000' val='5000' />" + 
                "<input type='text' id='amountVel' readonly style=' border:0; color:#f6f31f1; font-weight:bold;'>" + 
                "<div id='maxMinBoundsVel'></div>" + 
                "<input type='text' id='amountLength' readonly style='width:250px; border:0; color:#669911; font-weight:bold;'>" + 
                "<div id='maxMinBoundsLength'></div>" +
                "<input type='text' id='amountTimeInterval' readonly style='width:310px; border:0; color:#f6931f; font-weight:bold;'>" + 
                "<div id='maxMinBoundsTimeInterval'></div>" + 
                "<input type='text' id='amountTimeDuration' readonly style='width:310px; border:0; color:#23339f; font-weight:bold;'>" + 
                "<div id='maxMinBoundsTimeDuration'></div>" + 
                "<input type='button' value='Create Pass by Lens' class='marker-create-button'/>" + 
                "<input type='button' value='Create Start point Lens' class='marker-create-Start-button'/>" + 
                "<input type='button' value='Create End point Lens' class='marker-create-End-button'/>" + 
                "<input type='button' value='Create average Velocity Lens' class='marker-create-VelocityAVG-button'/>" + 
                "<input type='button' value='Create Length Lens' class='marker-create-length-button'/>" + 
                "<input type='button' value='Create Time Interval Lens' class='marker-create-timeInterval-button'/>" +
                "<input type='button' value='Create Time Duration Lens' class='marker-create-timeDuration-button'/>").openOn(map);
            map.on('popupclose', function(e) {
                    lensPreCreationLayer.clearLayers();
                })
            var location= e.latlng;
            $('.marker-create-button').click(function () {
                console.log ($('#radiusBox').val() );
                if ($('#radiusBox').val() == "" || $('#radiusBox').val() <= 0 || $('#radiusBox').val() > 10000) {
                    popup2
                        .setLatLng(e.latlng)
                        .setContent("Fill with a value of 1 until 10000" )
                        .openOn(map);
                }
                else {
                    createLens(location.lng, location.lat, 5000,"Default",0,0).createLayers();
                }
            });
            $('.marker-create-Start-button').click(function () {
                console.log ($('#radiusBox').val() );
                if ($('#radiusBox').val() == "" || $('#radiusBox').val() <= 0 || $('#radiusBox').val() > 10000) {
                    popup2
                        .setLatLng(e.latlng)
                        .setContent("Fill with a value of 1 until 10000" )
                        .openOn(map);
                }
                else {
                    createQuery(location.lng, location.lat, $('#radiusBox').val(),"Start",0,0);
                }
            });
            $('.marker-create-End-button').click(function () {
                console.log ($('#radiusBox').val() );
                if ($('#radiusBox').val() == "" || $('#radiusBox').val() <= 0 || $('#radiusBox').val() > 10000) {
                    popup2
                        .setLatLng(e.latlng)
                        .setContent("Fill with a value of 1 until 10000" )
                        .openOn(map);
                }
                else {
                    createQuery(location.lng, location.lat, $('#radiusBox').val(),"End",0,0);
                }
            });
            $('.marker-create-VelocityAVG-button').click(function () {
                console.log ($('#radiusBox').val() );
                if ($('#radiusBox').val() == "" || $('#radiusBox').val() <= 0 || $('#radiusBox').val() > 10000) {
                    popup2
                        .setLatLng(e.latlng)
                        .setContent("Fill with a value of 1 until 10000" )
                        .openOn(map);
                }
                else {
                    createQuery(location.lng, location.lat, $('#radiusBox').val(),"Vel_avg",minValueVel,maxValueVel);
                }
            });
            $('.marker-create-length-button').click(function () {
                console.log ($('#radiusBox').val() );
                if ($('#radiusBox').val() == "" || $('#radiusBox').val() <= 0 || $('#radiusBox').val() > 10000) {
                    popup2
                        .setLatLng(e.latlng)
                        .setContent("Fill with a value of 1 until 10000" )
                        .openOn(map);
                }
                else {
                    createQuery(location.lng, location.lat, $('#radiusBox').val(),"Length",minValueLength,maxValueLength);
                }
            });
            $('.marker-create-timeInterval-button').click(function () {
                console.log ($('#radiusBox').val() );
                if ($('#radiusBox').val() == "" || $('#radiusBox').val() <= 0 || $('#radiusBox').val() > 10000) {
                    popup2
                        .setLatLng(e.latlng)
                        .setContent("Fill with a value of 1 until 10000" )
                        .openOn(map);
                }
                else {
                    createQuery(location.lng, location.lat, $('#radiusBox').val(),"Time_Interval",minValueTime,maxValueTime);
                }
            });
            $('.marker-create-timeDuration-button').click(function () {
                console.log ($('#radiusBox').val() );
                if ($('#radiusBox').val() == "" || $('#radiusBox').val() <= 0 || $('#radiusBox').val() > 10000) {
                    popup2
                        .setLatLng(e.latlng)
                        .setContent("Fill with a value of 1 until 10000" )
                        .openOn(map);
                }
                else {
                    createQuery(location.lng, location.lat, $('#radiusBox').val(),"Time_Duration",minValueTimeDuration,maxValueTimeDuration);
                }
            });
            
            $( function() {
                $( "#radiusValue" ).slider({
                range: true,
                min: 0,
                max: 500,
                values: [ 0, 500 ],
                slide: function( event, ui ) {
                    minValueVel =ui.values[ 0 ];
                    maxValueVel =ui.values[ 1 ];
                    $( "#amountVel" ).val( "Km/h " + ui.values[ 0 ] + " - Km/h " + ui.values[ 1 ] );
                }
                });
                $( "#amountVel" ).val( "Km/h" + $( "#slider-range" ).slider( "values", 0 ) +
                " - Km/h" + $( "#slider-range" ).slider( "values", 1 ) );
            } );

            $( function() {
                $( "#maxMinBoundsVel" ).slider({
                range: true,
                min: 0,
                max: 500,
                values: [ 0, 500 ],
                slide: function( event, ui ) {
                    minValueVel =ui.values[ 0 ];
                    maxValueVel =ui.values[ 1 ];
                    $( "#amountVel" ).val( "Km/h " + ui.values[ 0 ] + " - Km/h " + ui.values[ 1 ] );
                }
                });
                $( "#amountVel" ).val( "Km/h" + $( "#slider-range" ).slider( "values", 0 ) +
                " - Km/h" + $( "#slider-range" ).slider( "values", 1 ) );
            } );

            $( function() {
                $( "#maxMinBoundsLength" ).slider({
                range: true,
                min: 1,
                max: 500000,
                values: [ 1, 300000 ],
                slide: function( event, ui ) {
                    minValueLength =ui.values[ 0 ];
                    maxValueLength =ui.values[ 1 ];
                    $( "#amountLength" ).val( "Meters" + ui.values[ 0 ] + " - Meters" + ui.values[ 1 ] );
                }
                });
                $( "#amountLength" ).val( "Meters " + $( "#slider-range" ).slider( "values", 0 ) +
                " - Meters " + $( "#slider-range" ).slider( "values", 1 ) );
            } );

            $( function() {
                $( "#maxMinBoundsTimeInterval" ).slider({
                range: true,
                min: 1201959044 , // 2008-02-02 13:30:44
                max: 1202492358 , // 2008-02-08 17:39:18
                values: [ 1201959044 , 1202492358  ],
                slide: function( event, ui ) {
                    minValueTime =ui.values[ 0 ];
                    maxValueTime =ui.values[ 1 ];
                    $( "#amountTimeInterval" ).val(Unix_timestamp(minValueTime * 1000) + " - " + Unix_timestamp(maxValueTime * 1000) );
                }
                });
                $( "#amountTimeInterval" ).val($( "#slider-range" ).slider( "values", 0 ) +
                " - " + $( "#slider-range" ).slider( "values", 1 ) );
            } );

            $( function() {
                $( "#maxMinBoundsTimeDuration" ).slider({
                range: true,
                min: 0, // 2008-02-02 13:30:44
                max: 85839, // 2008-02-08 17:39:18
                values: [ 0, 85839 ],
                slide: function( event, ui ) {
                    minValueTimeDuration =ui.values[ 0 ];
                    maxValueTimeDuration =ui.values[ 1 ];
                    $( "#amountTimeDuration" ).val(minValueTimeDuration + " - " + maxValueTimeDuration);
                }
                });
                $( "#amountTimeDuration" ).val( "Min duration " + $( "#slider-range" ).slider( "values", 0 ) +
                " - Max time " + $( "#slider-range" ).slider( "values", 1 ) );
            } );

            $('#radiusBox').on('input',function(){
                var myVar = $(this).val();
                previewCircle.setRadius( myVar);
                
            });*/
        }
        function attributeLensMenu(e){
            lensPreCreationLayer.clearLayers();
            createALens(e.latlng, 1000,'time','color').createAreas().createLayers();
        }

        /////
        /////
        /////

        /////
        ///// Create Lens' circle (lens it self)
        /////

        function createLens(lng, lat, radiusQuery, _type, minVal, maxVal){
            var lens = { type: _type, 
                areaQuery : L.circle([lat, lng], {
                    color: 'DarkRed',
                    fillColor: 'red',
                    fillOpacity: 0.6,
                    radius: radiusQuery,
                    pane: 'lensPane'
                }).addTo(lensesLayer),
                outsideCircle : null,
                lngLat : [lat,lng],
                radiusQuery : radiusQuery,
                type : _type,
                minV : minVal,
                maxV : maxVal,
                lngLatOLD : [lat,lng],
                radiusQueryOLD : radiusQuery,
                typeOLD : _type,
                minVOLD : minVal,
                maxVOLD : maxVal,
                lID : null,
                bounds : null,
                getMinV: function (){
                    return this.minV;
                },
                getMaxV: function (){
                    return this.maxV;
                },
                getType: function (){
                    return this.type;
                },
                setMinV: function (value){
                    this.minV = value;
                },
                setMaxV: function (value){
                    this.maxV = value;
                },
                setType: function (value){
                    this.type = value;
                },
                setLngLat : function (value){
                    this.lngLat = value;
                },
                getMinVOLD: function (){
                    return this.minVOLD;
                },
                getMaxVOLD: function (){
                    return this.maxVOLD;
                },
                getTypeOLD: function (){
                    return this.typeOLD;
                },
                setMinVOLD: function (value){
                    this.minVOLD = value;
                },
                setMaxVOLD: function (value){
                    this.maxVOLD = value;
                },
                setTypeOLD: function (value){
                    this.typeOLD = value;
                },
                setLngLatOLD : function (value){
                    this.lngLatOLD = value;
                },
                setBounds : function (value){
                    this.bounds = value;
                },
                setlID : function (value){
                    this.lID = value;
                },
                getLngLat : function (){
                    return this.lngLat;
                },
                getLngLatOLD : function (){
                    return this.lngLatOLD;
                },
                getBound : function (){
                    return this.bounds;
                },
                getlID : function (){
                    return this.lID;
                },
                setOutsideCircle: function(circle){
                    this.outsideCircle = circle;
                },
                setRadius : function (value){
                    this.areaQuery.setRadius(value);
                    this.radiusQuery = value;
                },
                getRadius : function (){
                    return this.radiusQuery;
                },
                setRadiusOLD : function (value){
                    this.radiusQueryOLD = value;
                },
                getRadiusOLD : function (){
                    return this.radiusQueryOLD;
                },
                colorSuccess : function() {
                    if(_type == "Default"){
                        console.log("I will now paint the Pass by circle again ....")
                        lens.areaQuery.setStyle({color: 'DodgerBlue', fillColor: 'DodgerBlue', fillOpacity: 0.2});
                    }
                    else if(_type == "Start"){
                        console.log("I will now paint the Start circle again ....")
                        lens.areaQuery.setStyle({color: 'MediumSeaGreen', fillColor: 'MediumSeaGreen', fillOpacity: 0.2});
                    }
                    else if(_type == "End"){
                        console.log("I will now paint the End circle again ....")
                        lens.areaQuery.setStyle({color: 'Violet', fillColor: 'Violet', fillOpacity: 0.2});
                    }
                    else if(_type == "Vel_avg"){
                        console.log("I will now paint the End circle again ....")
                        lens.areaQuery.setStyle({color: 'orange', fillColor: 'orange', fillOpacity: 0.2});
                    }
                    else if(_type == "Length"){
                        console.log("I will now paint the End circle again ....")
                        lens.areaQuery.setStyle({color: 'SlateBlue', fillColor: 'SlateBlue', fillOpacity: 0.2});
                    }
                    else if(_type == "Time_Interval"){
                        console.log("I will now paint the End circle again ....")
                        lens.areaQuery.setStyle({color: 'purple', fillColor: 'purple', fillOpacity: 0.2});
                    }
                    else if(_type == "Time_Duration"){
                        console.log("I will now paint the End circle again ....")
                        lens.areaQuery.setStyle({color: 'DarkTurquoise ', fillColor: 'DarkTurquoise ', fillOpacity: 0.2});
                    }
                },
                createLayers: function(){
                    //lensPreCreationLayer.clearLayers();
                    console.log("Im removing the map now and adding new ones afterwards")
                    if(defaultLayerFlag){
                        defaultLayerFlag = false;
                        map.removeLayer(defaultLayer);
                    }

                    if(lastMarkerGroupID !=null){
                        markerGroup.removeLayer(lastMarkerGroupID);
                        lastMarkerGroupID = null;
                    }
                    if(lastMarkerGroupID1 !=null){
                        markerGroup1.removeLayer(lastMarkerGroupID1);
                        lastMarkerGroupID1 = null;
                    }
                    if(lastMarkerGroupID2 !=null){
                        markerGroup2.removeLayer(lastMarkerGroupID2);
                        lastMarkerGroupID2 = null;
                    }
                    if(lastMarkerGroupID3 !=null){
                        markerGroup3.removeLayer(lastMarkerGroupID3);
                        lastMarkerGroupID3 = null;
                    }

                        // Create URL
                    var urlString3 = "query/trajectory_lines/"  + this.getLngLat()[1] + "/" + this.getLngLat()[0] + "/" + this.getRadius() + "/" + this.getType() + "/" + this.getMinV() + "/" + this.getMaxV();
                    var urlString2 = "query/trajectory_lines1/" + this.getLngLat()[1] + "/" + this.getLngLat()[0] + "/" + this.getRadius() + "/" + this.getType() + "/" + this.getMinV() + "/" + this.getMaxV();
                    var urlString1 = "query/trajectory_lines2/" + this.getLngLat()[1] + "/" + this.getLngLat()[0] + "/" + this.getRadius() + "/" + this.getType() + "/" + this.getMinV() + "/" + this.getMaxV();
                    var urlString  = "query/trajectory_lines3/" + this.getLngLat()[1] + "/" + this.getLngLat()[0] + "/" + this.getRadius() + "/" + this.getType() + "/" + this.getMinV() + "/" + this.getMaxV();
                    

                    var thisVar = this;

                    var newData = $.ajax({
                        url: urlString,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("Data successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    }) 
                    $.when(newData).done(function() {
                        if(newData.responseJSON.features != null){
                            var tracksToDraw = L.geoJson(newData.responseJSON,firstStyle);
                            tracksToDraw.addTo(markerGroup);
                            lastMarkerGroupID = tracksToDraw._leaflet_id;
                            thisVar.colorSuccess();
                        }
                        lensesLayer.bringToFront();
                    }); 
                    var newData1 = $.ajax({
                        url: urlString1,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("Data successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    }) 
                    $.when(newData1).done(function() {
                        if(newData1.responseJSON.features != null){
                            var tracksToDraw = L.geoJson(newData1.responseJSON,firstStyle);
                            tracksToDraw.addTo(markerGroup1);
                            lastMarkerGroupID1 = tracksToDraw._leaflet_id;
                            thisVar.colorSuccess();
                        }
                        lensesLayer.bringToFront();
                    });
                    var newData2 = $.ajax({
                        url: urlString2,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("Data successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    }) 
                    $.when(newData2).done(function() {
                        if(newData2.responseJSON.features != null){
                            var tracksToDraw = L.geoJson(newData2.responseJSON,firstStyle);
                            tracksToDraw.addTo(markerGroup2);
                            lastMarkerGroupID2 = tracksToDraw._leaflet_id;
                            thisVar.colorSuccess();
                        }
                        lensesLayer.bringToFront();
                    });
                    var newData3 = $.ajax({
                        url: urlString3,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("Data successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    }) 
                    $.when(newData3).done(function() {
                        if(newData3.responseJSON.features != null){
                            var tracksToDraw = L.geoJson(newData3.responseJSON,firstStyle);
                            tracksToDraw.addTo(markerGroup3);
                            lastMarkerGroupID3 = tracksToDraw._leaflet_id;
                            thisVar.colorSuccess();
                        }
                        lensesLayer.bringToFront();
                    });
                    
                    for(i = attLensesArray.length-1; i >= 0; i--){
                        attLensesArray[i].updateALL();
                    };
                },
                deleteLayers: function(){
                    lensesLayer.removeLayer(lens.areaQuery);
                    if(lastMarkerGroupID !=null){
                        markerGroup.removeLayer(lastMarkerGroupID);
                        lastMarkerGroupID = null;
                    }
                    if(lastMarkerGroupID1 !=null){
                        markerGroup1.removeLayer(lastMarkerGroupID1);
                        lastMarkerGroupID1 = null;
                    }
                    if(lastMarkerGroupID2 !=null){
                        markerGroup2.removeLayer(lastMarkerGroupID2);
                        lastMarkerGroupID2 = null;
                    }
                    if(lastMarkerGroupID3 !=null){
                        markerGroup3.removeLayer(lastMarkerGroupID3);
                        lastMarkerGroupID3 = null;
                    }
                    var urlString3 = "queryRemoval/trajectory_lines/"  + this.getLngLat()[1] + "/" + this.getLngLat()[0] + "/" + this.getRadius() + "/" + this.getType()  + "/" + this.getMinV() + "/" + this.getMaxV();
                    var urlString2 = "queryRemoval/trajectory_lines1/" + this.getLngLat()[1] + "/" + this.getLngLat()[0] + "/" + this.getRadius() + "/" + this.getType()  + "/" + this.getMinV() + "/" + this.getMaxV();
                    var urlString1 = "queryRemoval/trajectory_lines2/" + this.getLngLat()[1] + "/" + this.getLngLat()[0] + "/" + this.getRadius() + "/" + this.getType()  + "/" + this.getMinV() + "/" + this.getMaxV();
                    var urlString  = "queryRemoval/trajectory_lines3/" + this.getLngLat()[1] + "/" + this.getLngLat()[0] + "/" + this.getRadius() + "/" + this.getType()  + "/" + this.getMinV() + "/" + this.getMaxV();
  
                    var newData = $.ajax({
                        url: urlString,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("1 successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    })
                    $.when(newData).done(function() {
                        
                        console.log("Im removing the map now and adding new ones afterwards")
                        
                        if(newData.responseJSON.features != null){
                            var tracksToDraw = L.geoJson(newData.responseJSON,firstStyle);
                            tracksToDraw.addTo(markerGroup);
                            var idTracks = tracksToDraw._leaflet_id;
                            lastMarkerGroupID = tracksToDraw._leaflet_id;
                            
                        }
                        lensesLayer.bringToFront();
                        
                    });
                    var newData1 = $.ajax({
                        url: urlString1,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("2 successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    })
                    $.when(newData1).done(function() {
                        
                        console.log("Im removing the map now and adding new ones afterwards")
                        
                        if(newData1.responseJSON.features != null){
                            var tracksToDraw = L.geoJson(newData1.responseJSON,firstStyle);
                            tracksToDraw.addTo(markerGroup1);
                            lastMarkerGroupID1 = tracksToDraw._leaflet_id;
                            
                        }
                        lensesLayer.bringToFront();
                    });
                    var newData2 = $.ajax({
                        url: urlString2,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("3 successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    })
                    $.when(newData2).done(function() {
                        
                        console.log("Im removing the map now and adding new ones afterwards")
                        
                        if(newData2.responseJSON.features != null){
                            var tracksToDraw = L.geoJson(newData2.responseJSON,firstStyle);
                            tracksToDraw.addTo(markerGroup2);
                            lastMarkerGroupID2 = tracksToDraw._leaflet_id;
                            
                        }
                        lensesLayer.bringToFront();
                    });
                    var newData3 = $.ajax({
                        url: urlString3,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("4 successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    })
                    $.when(newData3).done(function() {
                        
                        console.log("Im removing the map now and adding new ones afterwards")
                        
                        if(newData3.responseJSON.features != null){
                            var tracksToDraw = L.geoJson(newData3.responseJSON,firstStyle);
                            tracksToDraw.addTo(markerGroup3);
                            lastMarkerGroupID3 = tracksToDraw._leaflet_id;
                            
                        }
                        lensesLayer.bringToFront();
                    });

                    for(i = attLensesArray.length-1; i >= 0; i--){
                        attLensesArray[i].updateALL();
                    };
                    
                },
                updateLENS: function(){
                    this.areaQuery.setStyle({color: 'DarkRed',fillColor: 'red',fillOpacity: 0.6});
                    var thisVar= this;
                    if(lastMarkerGroupID !=null){
                        markerGroup.removeLayer(lastMarkerGroupID);
                        lastMarkerGroupID = null;
                    }
                    if(lastMarkerGroupID1 !=null){
                        markerGroup1.removeLayer(lastMarkerGroupID1);
                        lastMarkerGroupID1 = null;
                    }
                    if(lastMarkerGroupID2 !=null){
                        markerGroup2.removeLayer(lastMarkerGroupID2);
                        lastMarkerGroupID2 = null;
                    }
                    if(lastMarkerGroupID3 !=null){
                        markerGroup3.removeLayer(lastMarkerGroupID3);
                        lastMarkerGroupID3 = null;
                    }
                    var urlString3 = "queryMoved/trajectory_lines/"  + this.getLngLatOLD()[1] + "/" + this.getLngLatOLD()[0] + "/" + this.getRadiusOLD() + "/" + this.getTypeOLD() + "/" + this.getMinVOLD() + "/" + this.getMaxVOLD()+"/"  + 
                    this.getLngLat()[1] + "/" + this.getLngLat()[0] + "/" + this.getRadius() + "/" + this.getType() + "/" + this.getMinV() + "/" + this.getMaxV();
                    var urlString2 = "queryMoved/trajectory_lines1/" + this.getLngLatOLD()[1] + "/" + this.getLngLatOLD()[0] + "/" + this.getRadiusOLD() + "/" + this.getTypeOLD() + "/" + this.getMinVOLD() + "/" + this.getMaxVOLD()+"/"  + 
                    this.getLngLat()[1] + "/" + this.getLngLat()[0] + "/" + this.getRadius() + "/" + this.getType() + "/" + this.getMinV() + "/" + this.getMaxV();
                    var urlString1 = "queryMoved/trajectory_lines2/" + this.getLngLatOLD()[1] + "/" + this.getLngLatOLD()[0] + "/" + this.getRadiusOLD() + "/" + this.getTypeOLD() + "/" + this.getMinVOLD() + "/" + this.getMaxVOLD()+"/"  + 
                    this.getLngLat()[1] + "/" + this.getLngLat()[0] + "/" + this.getRadius() + "/" + this.getType() + "/" + this.getMinV() + "/" + this.getMaxV();
                    var urlString  = "queryMoved/trajectory_lines3/" + this.getLngLatOLD()[1] + "/" + this.getLngLatOLD()[0] + "/" + this.getRadiusOLD() + "/" + this.getTypeOLD() + "/" + this.getMinVOLD() + "/" + this.getMaxVOLD()+"/"  + 
                    this.getLngLat()[1] + "/" + this.getLngLat()[0] + "/" + this.getRadius() + "/" + this.getType() + "/" + this.getMinV() + "/" + this.getMaxV();
                    
                    var newData = $.ajax({
                        url: urlString,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("1 successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    })
                    $.when(newData).done(function() {
                        
                        console.log("Im removing the map now and adding new ones afterwards")
                        
                        if(newData.responseJSON.features != null){
                            var tracksToDraw = L.geoJson(newData.responseJSON,firstStyle);
                            tracksToDraw.addTo(markerGroup);
                            var idTracks = tracksToDraw._leaflet_id;
                            lastMarkerGroupID = tracksToDraw._leaflet_id;
                            thisVar.colorSuccess();
                        }
                        
                        lensesLayer.bringToFront();
                        
                    });
                    var newData1 = $.ajax({
                        url: urlString1,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("2 successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    })
                    $.when(newData1).done(function() {
                        
                        console.log("Im removing the map now and adding new ones afterwards")
                        
                        if(newData1.responseJSON.features != null){
                            var tracksToDraw = L.geoJson(newData1.responseJSON,firstStyle);
                            tracksToDraw.addTo(markerGroup1);
                            lastMarkerGroupID1 = tracksToDraw._leaflet_id;
                            thisVar.colorSuccess();
                        }
                        lensesLayer.bringToFront();
                    });
                    var newData2 = $.ajax({
                        url: urlString2,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("3 successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    })
                    $.when(newData2).done(function() {
                        
                        console.log("Im removing the map now and adding new ones afterwards")
                        
                        if(newData2.responseJSON.features != null){
                            var tracksToDraw = L.geoJson(newData2.responseJSON,firstStyle);
                            tracksToDraw.addTo(markerGroup2);
                            lastMarkerGroupID2 = tracksToDraw._leaflet_id;
                            thisVar.colorSuccess();
                        }
                        lensesLayer.bringToFront();
                    });
                    var newData3 = $.ajax({
                        url: urlString3,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("4 successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    })
                    $.when(newData3).done(function() {
                        
                        console.log("Im removing the map now and adding new ones afterwards")
                        
                        if(newData3.responseJSON.features != null){
                            var tracksToDraw = L.geoJson(newData3.responseJSON,firstStyle);
                            tracksToDraw.addTo(markerGroup3);
                            lastMarkerGroupID3 = tracksToDraw._leaflet_id;
                            thisVar.colorSuccess();
                        }
                        lensesLayer.bringToFront();
                    });

                    for(i = attLensesArray.length-1; i >= 0; i--){
                        attLensesArray[i].updateALL();
                    };

                }
            };
            
            lens.setBounds(lens.areaQuery.getBounds());

            

            /*CALCULATE THE DISTANCE FROM ONE POINT TO ANOTHER IN PIXELS
            var northVar = map.latLngToLayerPoint(lens.areaQuery.getBounds().getNorthWest());
            var southVar = map.latLngToLayerPoint(lens.areaQuery.getBounds().getSouthWest());
            var numOfPixl = northVar.distanceTo(southVar);*/
            var myOutsideCircle = L.divIcon({className: 'outside-Circle', iconSize: [100,100],iconAnchor:[90,90], html: 
                "<input type='button' value='X' class='myDeleteButton' style='z-index: 1000;     position: fixed;margin: -16%;'/>"+
                "<div class='dropdown' style='        margin-left: -9.5%; margin-top: 87.5%;'><button class='dropbtn'><img src='images/type.png' style='width: 15px; height: 17px;'></button><div class='dropdown-content'>" + 
                "<button class='dropbtnOpt-default'>Pass by</button>"+
                "<button class='dropbtnOpt-start'>Start point</button>"+
                "<button class='dropbtnOpt-end'>End point</button>"+
                "<button class='dropbtnOpt-duration'>Duration</button>"+
                "<button class='dropbtnOpt-time'>Time</button>"+
                "<button class='dropbtnOpt-length'>Length</button>"+
                "<button class='dropbtnOpt-velocity'>Average velocity</button>"+
                "</div></div>" +
                "<button class='myIntervalsButton' style='z-index: 1025; position:fixed;     margin-left: 81.5%;margin-top: 83%;'><img src='images/intervals.png' style='z-index: 999;width: 25px;height: 25px;    margin: inherit;margin-left: -3px;margin-top: -4px;'></button>"+
                "<button class='myRadiusButton' style='z-index: 1019; position:fixed;     margin-left: 78.5%; margin-top: -19%;'><img src='images/radius.png' style='z-index: 999;width: 25px;height: 25px;    margin: inherit;margin-left: -3px;margin-top: -4px;'></button>"+
                "<div id='sliderRadius' style='z-index:1018;left:-80px; top:-80px;display:none;'></div>"+
                "<div id='sliderIntervalVel' style='z-index:1020;left:-80px; top:-80px;display:none;'></div>"+
                "<div id='sliderIntervalLength' style='z-index:1021;left:-80px; top:-80px;display:none;'></div>"+
                "<div id='sliderIntervalDuration' style='z-index:1022;left:-80px; top:-80px;display:none;'></div>"+
                "<div id='sliderIntervalTime' style='z-index:1023;left:-80px; top:-80px;display:none;'></div>"
                /*"<input type='text' id='amountVel' readonly style=' border:0; color:#f6f31f1; font-weight:bold;'>" + 
                "<div id='maxMinBoundsVel' style='width:50px;height:50px'></div>" + 
                "<input type='text' id='amountLength' readonly style='width:50px; border:0; color:#669911; font-weight:bold;'>" + 
                "<div id='maxMinBoundsLength' style='width:50px;height:50px'></div>" +
                "<input type='text' id='amountTimeInterval' readonly style='width:50; border:0; color:#f6931f; font-weight:bold;'>" + 
                "<div id='maxMinBoundsTimeInterval' style='width:50px;height:50px'></div>" + 
                "<input type='text' id='amountTimeDuration' readonly style='width:50; border:0; color:#23339f; font-weight:bold;'>" + 
                "<div id='maxMinBoundsTimeDuration' style='width:50px;height:50px'></div>"*/ 
                //"<div class='dropdown'style='margin-left: 102.5%; margin-top: 75%;'><button class='dropbtn'><img src='images/encoding.png' style='width: 15px; height: 17px;'></button><div class='dropdown-content'>"
            });
            
            console.log(myOutsideCircle.options);
            var outsideCircVar = L.marker(lens.getLngLat(), {icon: myOutsideCircle, pane: 'outtterLensPane'});
            lens.setOutsideCircle(outsideCircVar);
            

            /*$( function() {
                $( "#maxMinBoundsVel" ).slider({
                range: true,
                min: 0,
                max: 500,
                values: [ 0, 500 ],
                slide: function( event, ui ) {
                    minValueVel =ui.values[ 0 ];
                    maxValueVel =ui.values[ 1 ];
                    $( "#amountVel" ).val( "Km/h " + ui.values[ 0 ] + " - Km/h " + ui.values[ 1 ] );
                }
                });
                $( "#amountVel" ).val( "Km/h" + $( "#slider-range" ).slider( "values", 0 ) +
                " - Km/h" + $( "#slider-range" ).slider( "values", 1 ) );
            } );

            $( function() {
                $( "#maxMinBoundsLength" ).slider({
                range: true,
                min: 1,
                max: 500000,
                values: [ 1, 300000 ],
                slide: function( event, ui ) {
                    minValueLength =ui.values[ 0 ];
                    maxValueLength =ui.values[ 1 ];
                    $( "#amountLength" ).val( "Meters" + ui.values[ 0 ] + " - Meters" + ui.values[ 1 ] );
                }
                });
                $( "#amountLength" ).val( "Meters " + $( "#slider-range" ).slider( "values", 0 ) +
                " - Meters " + $( "#slider-range" ).slider( "values", 1 ) );
            } );

            $( function() {
                $( "#maxMinBoundsTimeInterval" ).slider({
                range: true,
                min: 1201959044 , // 2008-02-02 13:30:44
                max: 1202492358 , // 2008-02-08 17:39:18
                values: [ 1201959044 , 1202492358  ],
                slide: function( event, ui ) {
                    minValueTime =ui.values[ 0 ];
                    maxValueTime =ui.values[ 1 ];
                    $( "#amountTimeInterval" ).val(Unix_timestamp(minValueTime * 1000) + " - " + Unix_timestamp(maxValueTime * 1000) );
                }
                });
                $( "#amountTimeInterval" ).val($( "#slider-range" ).slider( "values", 0 ) +
                " - " + $( "#slider-range" ).slider( "values", 1 ) );
            } );

            $( function() {
                $( "#maxMinBoundsTimeDuration" ).slider({
                range: true,
                min: 0, // 2008-02-02 13:30:44
                max: 85839, // 2008-02-08 17:39:18
                values: [ 0, 85839 ],
                slide: function( event, ui ) {
                    minValueTimeDuration =ui.values[ 0 ];
                    maxValueTimeDuration =ui.values[ 1 ];
                    $( "#amountTimeDuration" ).val(minValueTimeDuration + " - " + maxValueTimeDuration);
                }
                });
                $( "#amountTimeDuration" ).val( "Min duration " + $( "#slider-range" ).slider( "values", 0 ) +
                " - Max time " + $( "#slider-range" ).slider( "values", 1 ) );
            } );*/
                        
            var movedPos = false;
            var movedRadius = false;
            var movedOthers = false;
            lens.outsideCircle.on({
                dbclick:function(e){
                    L.DomEvent.stopPropagation(e);
                },
                click : function(e){
                    L.DomEvent.stopPropagation(e);
                },
                mousedown: function () {
                    
                    map.on('mousemove', function (e) {
                        map.dragging.disable();
                        movedPos = true;
                        lens.areaQuery.setLatLng(e.latlng);
                        lens.outsideCircle.setLatLng(e.latlng);
                    });
                },
                mouseup: function(e){
                    map.removeEventListener('mousemove');
                    if(movedPos){ 
                        movedPos = false;   
                        map.dragging.enable();
                    
                        lens.setLngLat([e.latlng.lat,e.latlng.lng]);
                        lens.updateLENS();
                        lens.setLngLatOLD([e.latlng.lat,e.latlng.lng]);
                        lens.setBounds(lens.areaQuery.getBounds());
                        for(i = attLensesArray.length-1; i >= 0; i--){
                            attLensesArray[i].updateALL();
                        };
                    }
                },
                mouseout:function(){
                    outterLensesLayer.removeLayer(lens.outsideCircle);
                }
            });
            lens.areaQuery.on({
                dbclick:function(e){
                    L.DomEvent.stopPropagation(e);
                },
                click: function(e){
                    L.DomEvent.stopPropagation(e);
                    outterLensesLayer.addLayer(lens.outsideCircle);
                    $('.myDeleteButton').click(function (e) {
                    
                        lens.deleteLayers();
                        for(i = attLensesArray.length-1; i >= 0; i--){
                            attLensesArray[i].updateALL();
                        };
                    });

                    $('.myIntervalsButton').click(function(e){
                        if(document.getElementById("sliderRadius").style.display=='none'){
                            if(lens.getType() == "Vel_avg") {
                                if(document.getElementById("sliderIntervalVel").style.display=='none'){
                                    document.getElementById("sliderIntervalVel").style.display="block";

                                    var $sliderIntervalVel = $('#sliderIntervalVel');
                                    $sliderIntervalVel.mousedown( function (e){
                                        //TODO VELOCITY REMOVING BADLY??
                                        L.DomEvent.stopPropagation(e);
                                        map.dragging.disable();
                                        e.originalEvent.preventDefault();
                                    });
                                }
                                else document.getElementById("sliderIntervalVel").style.display="none";
                            }
                            if(lens.getType() == "Length") {
                                if(document.getElementById("sliderIntervalLength").style.display=='none'){
                                    document.getElementById("sliderIntervalLength").style.display="block";

                                    var $sliderIntervalLength = $('#sliderIntervalLength');
                                    $sliderIntervalLength.mousedown( function (e){
                                        //TODO VELOCITY REMOVING BADLY??
                                        L.DomEvent.stopPropagation(e);
                                        map.dragging.disable();
                                        e.originalEvent.preventDefault();
                                    });
                                }
                                else document.getElementById("sliderIntervalLength").style.display="none";
                            }
                            if(lens.getType() == "Time_Duration") {
                                if(document.getElementById("sliderIntervalDuration").style.display=='none'){
                                    document.getElementById("sliderIntervalDuration").style.display="block";

                                    var $sliderIntervalDuration = $('#sliderIntervalDuration');
                                    $sliderIntervalDuration.mousedown( function (e){
                                        //TODO VELOCITY REMOVING BADLY??
                                        L.DomEvent.stopPropagation(e);
                                        map.dragging.disable();
                                        e.originalEvent.preventDefault();
                                    });
                                }
                                else document.getElementById("sliderIntervalDuration").style.display="none";
                            }
                            if(lens.getType() == "Time_Interval") {
                                if(document.getElementById("sliderIntervalTime").style.display=='none'){
                                    document.getElementById("sliderIntervalTime").style.display="block";

                                    var $sliderIntervalTime = $('#sliderIntervalTime');
                                    $sliderIntervalTime.mousedown( function (e){
                                        //TODO VELOCITY REMOVING BADLY??
                                        L.DomEvent.stopPropagation(e);
                                        map.dragging.disable();
                                        e.originalEvent.preventDefault();
                                    });
                                }
                                else document.getElementById("sliderIntervalTime").style.display="none";
                            }
                        } 
                        
                        $(function(){
                            $("#sliderIntervalVel").roundSlider({
                                sliderType: "range",
                                radius: "130px",
                                value: lens.getMinV() + "," + lens.getMaxV(),
                                min: 0,
                                max: 250,
                                //lineCap: "round",
                                width: 5,
                                editableTooltip: false,
                                handleSize: "+10",
                                handleShape: "dot",
                                drag: function (e) {
                                    L.DomEvent.stopPropagation(e);
                                    
                                    var index = e.value.indexOf(",");  // Gets the first index where a , occours
                                    var firstPart = e.value.substr(0, index); // Gets the first part
                                    var secondPart = e.value.substr(index + 1);  // Gets the text part
                                    lens.setMinV(firstPart);
                                    lens.setMaxV(secondPart);
                                    console.log(lens.getMinV());
                                    console.log(lens.getMaxV());
                                },
                                start: function(e) {
                                    
                                },
                                stop: function (e) {
                                    L.DomEvent.stopPropagation(e);
                                    map.dragging.enable();
                                    lens.updateLENS();
                                    lens.setMinVOLD(lens.getMinV());
                                    lens.setMaxVOLD(lens.getMaxV());
                                }
                            });
                            
                            $("#sliderIntervalLength").roundSlider({
                                sliderType: "range",
                                radius: "130px",
                                value: lens.getMinV() + "," + lens.getMaxV(),
                                min: 1,
                                max: 500000,
                                //lineCap: "round",
                                width: 5,
                                editableTooltip: false,
                                handleSize: "+10",
                                handleShape: "dot",
                                drag: function (e) {
                                    L.DomEvent.stopPropagation(e);
                                    
                                    var index = e.value.indexOf(",");  // Gets the first index where a , occours
                                    var firstPart = e.value.substr(0, index); // Gets the first part
                                    var secondPart = e.value.substr(index + 1);  // Gets the text part
                                    lens.setMinV(firstPart);
                                    lens.setMaxV(secondPart);
                                    console.log(lens.getMinV());
                                    console.log(lens.getMaxV());
                                },
                                start: function(e) {
                                    
                                },
                                stop: function (e) {
                                    L.DomEvent.stopPropagation(e);
                                    map.dragging.enable();
                                    lens.updateLENS();
                                    lens.setMinVOLD(lens.getMinV());
                                    lens.setMaxVOLD(lens.getMaxV());
                                }
                            });
                            
                            $("#sliderIntervalDuration").roundSlider({
                                sliderType: "range",
                                radius: "130px",
                                value: lens.getMinV() + "," + lens.getMaxV(),
                                min: 0, // 2008-02-02 13:30:44
                                max: 85839, // 2008-02-08 17:39:18
                                //lineCap: "round",
                                width: 5,
                                editableTooltip: false,
                                handleSize: "+10",
                                handleShape: "dot",
                                drag: function (e) {
                                    L.DomEvent.stopPropagation(e);
                                    
                                    var index = e.value.indexOf(",");  // Gets the first index where a , occours
                                    var firstPart = e.value.substr(0, index); // Gets the first part
                                    var secondPart = e.value.substr(index + 1);  // Gets the text part
                                    lens.setMinV(firstPart);
                                    lens.setMaxV(secondPart);
                                    console.log(lens.getMinV());
                                    console.log(lens.getMaxV());
                                },
                                start: function(e) {
                                    
                                },
                                stop: function (e) {
                                    L.DomEvent.stopPropagation(e);
                                    map.dragging.enable();
                                    lens.updateLENS();
                                    lens.setMinVOLD(lens.getMinV());
                                    lens.setMaxVOLD(lens.getMaxV());
                                }
                            });
                            
                            $("#sliderIntervalTime").roundSlider({
                                sliderType: "range",
                                radius: "130px",
                                value: lens.getMinV() + "," + lens.getMaxV(),
                                min: 1201959044 , // 2008-02-02 13:30:44
                                max: 1202492358 , // 2008-02-08 17:39:18
                                //lineCap: "round",
                                width: 5,
                                editableTooltip: false,
                                handleSize: "+10",
                                handleShape: "dot",
                                drag: function (e) {
                                    L.DomEvent.stopPropagation(e);
                                    
                                    var index = e.value.indexOf(",");  // Gets the first index where a , occours
                                    var firstPart = e.value.substr(0, index); // Gets the first part
                                    var secondPart = e.value.substr(index + 1);  // Gets the text part
                                    lens.setMinV(firstPart);
                                    lens.setMaxV(secondPart);
                                    console.log(lens.getMinV());
                                    console.log(lens.getMaxV());
                                },
                                start: function(e) {
                                    
                                },
                                stop: function (e) {
                                    L.DomEvent.stopPropagation(e);
                                    map.dragging.enable();
                                    lens.updateLENS();
                                    lens.setMinVOLD(lens.getMinV());
                                    lens.setMaxVOLD(lens.getMaxV());
                                }
                            });
                        });
                    });
                     

                    $('.myRadiusButton').click(function (e) {
                        L.DomEvent.stopPropagation(e); 
                        if(document.getElementById("sliderRadius").style.display=='none' && document.getElementById("sliderRadius").style.display=='none'){
                            document.getElementById("sliderRadius").style.display="block";
                            var $sliderRadius = $('#sliderRadius');
                            $sliderRadius.mousedown( function (e){
                                //TODO VELOCITY REMOVING BADLY??
                                L.DomEvent.stopPropagation(e);
                                map.dragging.disable();
                                e.originalEvent.preventDefault();
                            });
                            $(function(){
                                $("#sliderRadius").roundSlider({
                                    sliderType: "min-range",
                                    radius: "130px",
                                    value: lens.getRadius(),
                                    min: 0,
                                    max: 10000,
                                    //lineCap: "round",
                                    width: 5,
                                    editableTooltip: false,
                                    handleSize: "+10",
                                    handleShape: "dot",
                                    drag: function (e) {
                                        L.DomEvent.stopPropagation(e);
                                        lens.setRadius(e.value); 
                                    },
                                    start: function(e) {
                                    },
                                    stop: function (e) {
                                        L.DomEvent.stopPropagation(e);
                                        map.dragging.enable();
                                        lens.updateLENS();
                                        lens.setBounds(lens.areaQuery.getBounds());
                                        for(i = attLensesArray.length-1; i >= 0; i--){
                                            attLensesArray[i].updateALL();
                                        };
                                        lens.setRadiusOLD(lens.getRadius());
                                    }
                                });
                            }); 
                            
                        }
                        else{
                            document.getElementById("sliderRadius").style.display="none";
                        }

                    }); 
                    
                    $('.dropbtnOpt-default').click(function () {
                            lens.setType("Default");
                            lens.setMinV(0);
                            lens.setMaxV(0);
                            lens.updateLENS();
                            lens.setTypeOLD("Default");
                            lens.setMinVOLD(0);
                            lens.setMaxVOLD(0);
                    });
                    $('.dropbtnOpt-start').click(function () {
                            lens.setType("Start");
                            lens.setMinV(0);
                            lens.setMaxV(0);
                            lens.updateLENS();
                            lens.setTypeOLD("Start");
                            lens.setMinVOLD(0);
                            lens.setMaxVOLD(0);
                    });
                    $('.dropbtnOpt-end').click(function () {
                            lens.setType("End");
                            lens.setMinV(0);
                            lens.setMaxV(0);
                            lens.updateLENS();
                            lens.setTypeOLD("End");
                            lens.setMinVOLD(0);
                            lens.setMaxVOLD(0);
                    });
                    $('.dropbtnOpt-length').click(function () {
                            
                            lens.setType("Length");
                            lens.setMinV(1);
                            lens.setMaxV(500000);
                            lens.updateLENS();
                            lens.setTypeOLD("Length");
                            lens.setMinVOLD(1);
                            lens.setMaxVOLD(500000);
                    });
                    $('.dropbtnOpt-velocity').click(function () {
                            lens.setType("Vel_avg");
                            lens.setMinV(0);
                            lens.setMaxV(250);
                            lens.updateLENS();
                            lens.setTypeOLD("Vel_avg");
                            lens.setMinVOLD(0);
                            lens.setMaxVOLD(250);
                    });
                    $('.dropbtnOpt-time').click(function () {
                            lens.setType("Time_Interval");
                            lens.setMinV(1201959044);
                            lens.setMaxV(1202492358);
                            lens.updateLENS();
                            lens.setTypeOLD("Time_Interval");
                            lens.setMinVOLD(1201959044);
                            lens.setMaxVOLD(1202492358);
                    });
                    $('.dropbtnOpt-duration').click(function () {
                            lens.setType("Time_Duration");
                            lens.setMinV(0);
                            lens.setMaxV(85839);
                            lens.updateLENS();
                            lens.setTypeOLD("Time_Duration");
                            lens.setMinVOLD(0);
                            lens.setMaxVOLD(85839);
                    });  
 
                }
            }); 
            /*lens.areaQuery.bindPopup("<input type='button' value='Delete this lens' class='marker-delete-button'/>")
            lens.areaQuery.on("popupopen", function() {
                //var tempMarkerGeoJSON = this.toGeoJSON();

                //var lID = tempMarker._leaflet_id; // Getting Leaflet ID of this marker

                // To remove marker on click of delete
                $('.marker-delete-button:visible').click(function () {
                    lensesLayer.removeLayer(lens.areaQuery);
                    
                    if(lastMarkerGroupID !=null){
                        markerGroup.removeLayer(lastMarkerGroupID);
                        lastMarkerGroupID = null;
                    }
                    if(lastMarkerGroupID1 !=null){
                        markerGroup1.removeLayer(lastMarkerGroupID1);
                        lastMarkerGroupID1 = null;
                    }
                    if(lastMarkerGroupID2 !=null){
                        markerGroup2.removeLayer(lastMarkerGroupID2);
                        lastMarkerGroupID2 = null;
                    }
                    if(lastMarkerGroupID3 !=null){
                        markerGroup3.removeLayer(lastMarkerGroupID3);
                        lastMarkerGroupID3 = null;
                    }
                    deleteQuery(lng, lat, radiusQuery, _type, minVal, maxVal);
                    attLensesArray.forEach(function(item, index, array) {
                        item.updateALL();
                    });
                });
                    
            }) ; */
            
            return lens
        }

        function createALens(lngLat, radiusQuery, _attribute, _encoding){
            var lens = { 
                areaQuery : L.circle([lngLat.lat, lngLat.lng], {
                    color: 'DarkRed',
                    fillColor: 'red',
                    fillOpacity: 0.6,
                    radius: radiusQuery,
                    pane: 'lensPane'
                }).addTo(lensesLayer),
                outsideCircle : null,
                lngLat : lngLat,
                radiusQuery : radiusQuery,
                lID : null,
                att : _attribute,
                enc : _encoding,
                intersections: [],
                areas: [],
                bounds : null,
                addIntersection: function (obj){
                    this.intersections.push(obj);
                },
                removeIntersection: function (obj){
                    for(var i = this.intersections.length - 1; i >= 0; i--) {
                        if(this.intersections[i] === obj) {
                            this.intersections.splice(i, 1);
                            return true;
                        }
                    }
                    return false;
                },
                addArea: function (obj){
                    this.areas.push(obj);
                },
                removeArea: function (obj){
                    for(var i = this.areas.length - 1; i >= 0; i--) {
                        if(this.areas[i] === obj) {
                            this.areas.splice(i, 1);
                            return true;
                        }
                    }
                    return false;
                },
                setLngLat : function (value){
                    this.lngLat = value;
                },
                setBounds : function (value){
                    this.bounds = value;
                },
                setlID : function (value){
                    this.lID = value;
                },
                getLngLat : function (){
                    return this.lngLat;
                },
                getBound : function (){
                    return this.bounds;
                },
                getlID : function (){
                    return this.lID;
                },
                setOutsideCircle: function(circle){
                    this.outsideCircle = circle;
                },
                setRadius : function (value){
                    this.areaQuery.setRadius(value);
                    this.radiusQuery = value;
                },
                getRadius : function (){
                    return this.radiusQuery;
                },
                colorSuccess : function() {
                    //if(_attribute == "length"){
                    console.log("I will now paint the Pass by circle again ....")
                    this.areaQuery.setStyle({color: '#FFFFFF', fillColor: '#FFFFFF', fillOpacity: 0.01});
                    
                },
                updateLayer : function(layer, value){
                    //var layersActive = layersWithin(map, layer, lngLat, pixelsInRadius)
                    //TODO
                    switch(this.att) {
                        case "length":
                            lengthAtt(layer, value,this.enc);
                            break;
                        case "duration":
                            durationAtt(layer,value, this.enc);
                            break;
                        case "vel":
                            velocityAtt(layer,value,this.enc);
                            break;
                        case "time":
                            timeAtt(layer,value, this.enc);
                            break;
                    }   
                },
                addToLensArrayAndIntersections : function(){
                    for(i=0; i< attLensesArray.length;i++){
                        if(this.areaQuery.getBounds().intersects(attLensesArray[i].areaQuery.getBounds())){
                            this.addIntersection(attLensesArray[i]);
                        }
                    }
                    attLensesArray.push(this);
                },
                createAreas : function( ){
                    this.addToLensArrayAndIntersections();

                    var radius = this.getRadius()/1000;
                    var options = {steps: 64, units: 'kilometers'};
                    var circle = turf.circle([this.getLngLat().lng, this.getLngLat().lat], radius, options);
                    
                    var firstArea = creaAttAreas(circle);
                    firstArea.addLens(this);
                    this.addArea(firstArea);
                    for(i = this.intersections.length-1; i>=0; i--){
                        for(j = this.intersections[i].areas.length - 1; j>=0; j--){

                            var intersection = turf.intersect(this.areas[0].area.geometry,this.intersections[i].areas[j].area.geometry);
                            if(intersection!= null){
                                var difference = turf.difference(this.areas[0].area.geometry,this.intersections[i].areas[j].area.geometry);
                                this.areas[0].setArea(difference);
                                
                                var lensArrOfArea = this.intersections[i].areas[j].getLensArray();
                                var newArea = creaAttAreas(intersection);
                                for(k = 0; k < lensArrOfArea.length;k++){
                                    newArea.addLens(lensArrOfArea[k]);
                                }
                                newArea.addLens(this);
                                this.addArea(newArea);
                            }
                        }
                    }
                    return this;
                },
                createLayers : function(){

                    this.areas.forEach(function(eachArea, index, array) {
                        eachArea.createLayers();
                    });
                    this.colorSuccess();

                    /*var attLayer = L.featureGroup({pane: 'attLensPane'}).addTo(attLenResults);
                    var _attLayer = L.featureGroup({pane: 'attLensPane'}).addTo(attLayer);
                    var _attLayer1 = L.featureGroup({pane: 'attLensPane'}).addTo(attLayer);
                    var _attLayer2 = L.featureGroup({pane: 'attLensPane'}).addTo(attLayer);
                    var _attLayer3 = L.featureGroup({pane: 'attLensPane'}).addTo(attLayer);
                    
                    var radius = this.getRadius()/1000;
                    var options = {steps: 64, units: 'kilometers'};
                    var circle = turf.circle([this.getLngLat().lng, this.getLngLat().lat], radius, options);
                    circle = turf.toMercator(circle);
                    circle = turf.toWgs84(circle);
                    var strCircle = JSON.stringify(circle.geometry);
                    
                    console.log("yoooooooo");console.log(strCircle);

                        // Create URL
                    var urlString3 = "attQueryNEW/trajectory_lines/"  + strCircle;
                    var urlString2 = "attQueryNEW/trajectory_lines1/" + strCircle;
                    var urlString1 = "attQueryNEW/trajectory_lines2/" + strCircle;
                    var urlString  = "attQueryNEW/trajectory_lines3/" + strCircle;
                    
                    this.setlID(attLayer._leaflet_id);
                    var newData = $.ajax({
                        url: urlString,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("Data successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    }) 
                    $.when(newData).done(function() {
                        
                        if(newData.responseJSON.features != null){
                            newData.responseJSON.features.forEach(function(item, index, array) {
                                var tracksToDraw = L.geoJson(item,firstStyleATT);
                                switch(lens.att) {
                                    case "length":
                                        lengthAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                    case "duration":
                                        // code block
                                        durationAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                    case "vel":
                                        velocityAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                    case "time":
                                        timeAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                } 
                                lens.intersections.forEach(function(lensInt, index, array) {
                                    if(lensInt.areaQuery.getBounds().intersects(tracksToDraw.getBounds())){
                                        lensInt.updateLayer(tracksToDraw,item.properties)
                                    }
                                });
                                tracksToDraw.addTo(_attLayer);
                            });
                            
                        }
                    }); 
                    var newData1 = $.ajax({
                        url: urlString1,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("Data successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    }) 
                    $.when(newData1).done(function() {
                        if(newData1.responseJSON.features != null){
                            newData1.responseJSON.features.forEach(function(item, index, array) {
                                var tracksToDraw = L.geoJson(item,firstStyleATT);
                                switch(lens.att) {
                                    case "length":
                                        lengthAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                    case "duration":
                                        // code block
                                        durationAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                    case "vel":
                                        velocityAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                    case "time":
                                        timeAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                } 
                                lens.intersections.forEach(function(lensInt, index, array) {
                                    if(lensInt.areaQuery.getBounds().intersects(tracksToDraw.getBounds())){
                                        lensInt.updateLayer(tracksToDraw,item.properties)
                                    }
                                });
                                tracksToDraw.addTo(_attLayer1);
                            });
                            
                        }
                    });
                    var newData2 = $.ajax({
                        url: urlString2,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("Data successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    }) 
                    $.when(newData2).done(function() {
                        if(newData2.responseJSON.features != null){
                            newData2.responseJSON.features.forEach(function(item, index, array) {
                                var tracksToDraw = L.geoJson(item,firstStyleATT);
                                switch(lens.att) {
                                    case "length":
                                        lengthAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                    case "duration":
                                        // code block
                                        durationAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                    case "vel":
                                        velocityAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                    case "time":
                                        timeAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                } 
                                lens.intersections.forEach(function(lensInt, index, array) {
                                    if(lensInt.areaQuery.getBounds().intersects(tracksToDraw.getBounds())){
                                        lensInt.updateLayer(tracksToDraw,item.properties)
                                    }
                                });
                                tracksToDraw.addTo(_attLayer2);
                            });
                            
                        }
                    });
                    var newData3 = $.ajax({
                        url: urlString3,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("Data successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    }) 
                    $.when(newData3).done(function() {
                        if(newData3.responseJSON.features != null){
                            newData3.responseJSON.features.forEach(function(item, index, array) {
                                var tracksToDraw = L.geoJson(item,firstStyleATT);
                                switch(lens.att) {
                                    case "length":
                                        lengthAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                    case "duration":
                                        // code block
                                        durationAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                    case "vel":
                                        velocityAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                    case "time":
                                        timeAtt(tracksToDraw, item.properties, lens.enc);
                                        break;
                                } 
                                lens.intersections.forEach(function(lensInt, index, array) {
                                    if(lensInt.areaQuery.getBounds().intersects(tracksToDraw.getBounds())){
                                        lensInt.updateLayer(tracksToDraw,item.properties)
                                    }
                                });
                                tracksToDraw.addTo(_attLayer3);
                            });
                            
                            
                        }
                    });
                    this.colorSuccess();
                   */ 
                },
                updateALL : function (){
                    //TODO CHAMAR ARRAY DE TRAS PARA A FRENTE PARA NAO TER DE FAZER VERIFICACOES  
                    this.delete();
                    this.updateOthersV2(false);
                    this.createAreas();
                    this.createLayers();
                },
                updateLENS : function(attORenc , value){
                    //Will check if any of the lenses if any of the intersections has an area wich recieves the styling from it
                    var foundMyself = false;
                    console.log(attLensesArray);
                    for(var i = 0;i<attLensesArray.length ;i++) {
                        console.log("I enntered the array");
                        console.log(attLensesArray[i]);
                        if(attLensesArray[i] === this) {
                            console.log("Found the lens");
                            foundMyself = true;
                        }
                        else if(foundMyself){
                            for(var j = 0; j < attLensesArray[i].intersections.length; j++) {
                                if(attLensesArray[i].intersections[j] === this){
                                    console.log("YOOOOOO IM FUCKING HERE ONCE AGAIN BIATCH");
                                    if(attORenc){
                                        attLensesArray[i].intersections[j].att = value;
                                    }
                                    //False for encoding
                                    else{
                                        attLensesArray[i].intersections[j].enc = value;
                                    }
                                    attLensesArray[i].areas.forEach( function(item,index,array){
                                        item.updateLayer();
                                    });
                                }
                            }
                        }

                    }
                    //True for attriute
                    if(attORenc){
                        this.att = value;
                    }
                    //False for encoding
                    else{
                        this.enc = value;
                    }
                    this.areas.forEach( function(item,index,array){
                        item.updateLayer();
                    });
                    /*this.intersections.splice(0,this.intersections.length);
                    //this.updateOthers();
                    var thisVar = this;
                    
                    attLensesArray.forEach(function(item, index, array) {
                        if(thisVar.areaQuery.getBounds().intersects(item.areaQuery.getBounds())){
                            thisVar.addIntersection(item);
                        }
                    });
                    console.log("BELLOW IS THE INTNERSECTIONS OF THE LENS THAT WAS UPDATED");
                    console.log(this.intersections);
                    attLensesArray.push(lens);
                    console.log("Bellow is the attLensesArray");
                    console.log(attLensesArray);
                    attLenResults.getLayer(this.getlID()).eachLayer(function(oneOfFourATTLayers){
                        oneOfFourATTLayers.eachLayer(function(oneOfSmallLayerContainer){
                            oneOfSmallLayerContainer.eachLayer(function(oneOfSmallLayers) {
                                oneOfSmallLayers.setStyle(firstStyleATT);
                                thisVar.updateLayer(oneOfSmallLayers,oneOfSmallLayers.feature.properties);
                                thisVar.intersections.forEach(function(lensInt, index, array) {
                                    console.log(lensInt.areaQuery);
                                    if(lensInt.areaQuery.getBounds().intersects(oneOfSmallLayers.getBounds())){

                                        console.log("This layer intersects the other lenses");
                                        
                                        lensInt.updateLayer(oneOfSmallLayers,oneOfSmallLayers.feature.properties);
                                    }
                                });
                            });
                        });
                    });
                    attLenResults.getLayer(this.getlID()).bringToFront();
                    */
                },
                delete: function(){
                    for(var areaIndex = this.areas.length - 1;areaIndex>=0; areaIndex--){
                        this.areas[areaIndex].delete();
                        this.areas.pop();
                    }
                },
                removeFromAttLen : function(){
                    for(var i = attLensesArray.length - 1; i >= 0; i--) {
                        console.log("im in updateOthers");
                        if(attLensesArray[i] === this) {
                            console.log("i will splice the attLensesArray");
                            attLensesArray.splice(i, 1);
                            console.log(attLensesArray);
                            break;
                        }
                    }
                },
                updateOthersV2 : function( onlyRemoveInter ){
                    //true if areas need to e updated
                    this.removeFromAttLen();
                    for(i = 0; i<attLensesArray.length; i++){
                        console.log("AAAAAAAIXO");
                        console.log(attLensesArray[i]);
                        if(attLensesArray[i].removeIntersection(this)) {
                            if(onlyRemoveInter){
                                console.log(attLensesArray[i]);
                                console.log("CIMAAAAAAAA");
                                for(var areaIndex = 0;areaIndex < attLensesArray[i].areas.length; areaIndex++){
                                    if(attLensesArray[i].areas[areaIndex].removeLens(this)){
                                        if(attLensesArray[i].areas[areaIndex].getLensArray().length ==1){
                                            //IF ERROR APPEArS WHERE SOME PARTS ARE somewhat forgotten it might mean that splice allows for a jump?
                                            console.log("AGORA VOU MOSTRAR Os ARRAYs a JUNTAR");
                                            console.log(attLensesArray[i].areas[0].area);
                                            console.log(attLensesArray[i].areas[areaIndex].area);
                                            var unionVar = turf.union(attLensesArray[i].areas[0].area, attLensesArray[i].areas[areaIndex].area);
                                            attLensesArray[i].areas[0].setArea(unionVar);
                                            attLensesArray[i].areas[areaIndex].delete();
                                            attLensesArray[i].areas[0].delete();
                                            attLensesArray[i].areas.splice(areaIndex, 1);
                                            attLensesArray[i].areas[0].createLayers();
                                        }
                                        else attLensesArray[i].areas[areaIndex].updateLayer();
                                    }
                                }
                            }
                        }
                    }
                }
                /*updateOthers: function(){
                    for(var i = attLensesArray.length - 1; i >= 0; i--) {
                        if(attLensesArray[i] === this) {
                            attLensesArray.splice(i, 1);
                        }
                    }
                    var thisVar = this;
                    
                    attLensesArray.forEach(function (lensInGlobalArray,index,array){
                        console.log("AAAAAAAIXO");
                        console.log(lensInGlobalArray);
                        if(lensInGlobalArray.removeIntersection(thisVar)) {
                            console.log(lensInGlobalArray);
                            console.log("CIMAAAAAAAA");
                            
                            var layerofItem = attLenResults.getLayer(lensInGlobalArray.getlID());
                            layerofItem.eachLayer(function (layerHolder) {
                                layerHolder.eachLayer(function (layerContainer) {
                                    layerContainer.eachLayer(function (layer){
                                            if (thisVar.getBound().intersects(layer.getBounds())){
                                            console.log("This layer is inside the bounds");
                                            switch(thisVar.enc) {
                                                case "color":
                                                    layer.setStyle({color: '#FF6347'});
                                                    lensInGlobalArray.updateLayer(layer, layer.feature.properties);
                                                    lensInGlobalArray.intersections.forEach(function(itemInterLens, index, array) {
                                                        if (itemInterLens.areaQuery.getBounds().intersects(layer.getBounds())){
                                                            itemInterLens.updateLayer(layer, layer.feature.properties);
                                                        }
                                                    });
                                                    break;
                                                case "brightness":
                                                    layer.setStyle({color: '#FF6347'});
                                                    lensInGlobalArray.updateLayer(layer, layer.feature.properties);
                                                    lensInGlobalArray.intersections.forEach(function(itemInterLens, index, array) {
                                                        if (itemInterLens.areaQuery.getBounds().intersects(layer.getBounds())){
                                                            itemInterLens.updateLayer(layer, layer.feature.properties);
                                                        }
                                                    });
                                                    break;
                                                case "opacity":
                                                    console.log("Returning Opacity to 1");
                                                    layer.setStyle({opacity:1});
                                                    break;
                                                case "width":
                                                    console.log("Returning Width to 1.5");
                                                    layer.setStyle({"weight": 1.5});
                                                    break;
                                            }
                                        }
                                    });
                                });
                            });

                        }
                    });

                }*/
            };

            lens.setBounds(lens.areaQuery.getBounds());

            /*CALCULATE THE DISTANCE FROM ONE POINT TO ANOTHER IN PIXELS
            var northVar = map.latLngToLayerPoint(lens.areaQuery.getBounds().getNorthWest());
            var southVar = map.latLngToLayerPoint(lens.areaQuery.getBounds().getSouthWest());
            var numOfPixl = northVar.distanceTo(southVar);*/
            var myOutsideCircle = L.divIcon({className: 'outside-Circle', iconSize: [100,100],iconAnchor:[90,90], html: 
                "<input type='button' value='X' class='myDeleteButton' style='z-index: 1000;     position: fixed;margin: -16%;'/>"+
                "<div class='dropdown' style='        margin-left: -9.5%; margin-top: 87.5%;'><button class='dropbtn'><img src='images/attribute.png' style='width: 15px; height: 17px;'></button><div class='dropdown-content'>" + 
                "<button class='dropbtnOpt-length'>Length</button>"+
                "<button class='dropbtnOpt-velocity'>Velocity</button>"+
                "<button class='dropbtnOpt-time'>Time</button>"+
                "<button class='dropbtnOpt-duration'>Duration</button>"+
                "</div></div>" +
                "<div class='dropdown'style='margin-left: 81.5%;margin-top: 83%;'><button class='dropbtn'><img src='images/encoding.png' style='width: 15px; height: 17px;'></button><div class='dropdown-content'>" + 
                "<button class='dropbtnOpt-color'>Color</button>"+
                "<button class='dropbtnOpt-width'>Width</button>"+
                "<button class='dropbtnOpt-brightness'>Brightness</button>"+
                "<button class='dropbtnOpt-opacity'>Opacity</button>"+
                "</div></div>" +
                "<button class='myRadiusButton' style='z-index: 1019; position:fixed;     margin-left: 78.5%; margin-top: -19%;'><img src='images/radius.png' style='z-index: 999;width: 25px;height: 25px;    margin: inherit;margin-left: -3px;margin-top: -4px;'></button>"+
                "<div id='rotationSliderContainer' style='display:none;'><div id='rotationSlider'style='display:none;'></div> <div id='rotationSliderDegrees'style='display:none;'></div></div>"
                //"<div class='dropdown'style='margin-left: 102.5%; margin-top: 75%;'><button class='dropbtn'><img src='images/encoding.png' style='width: 15px; height: 17px;'></button><div class='dropdown-content'>"
            });
            var outsideCircVar = L.marker(lens.getLngLat(), {icon: myOutsideCircle, pane: 'outtterLensPane'});
            lens.setOutsideCircle(outsideCircVar);
            
            var moved = false;
            lens.outsideCircle.on({
                dbclick:function(e){
                    L.DomEvent.stopPropagation(e);
                },
                click : function(e){
                    L.DomEvent.stopPropagation(e);
                },
                mousedown: function () {
                    
                    map.on('mousemove', function (e) {
                        if(!(moved)){

                            lens.updateOthersV2(true);
                        }
                        map.dragging.disable();
                        moved = true;
                        lens.areaQuery.setLatLng(e.latlng);
                        lens.outsideCircle.setLatLng(e.latlng);
                        lens.lngLat = e.latlng;
                    });
                },
                mouseup: function(){
                    map.removeEventListener('mousemove');
                    if(moved){ 
                        moved = false;   
                        map.dragging.enable();
                        lens.delete();

                        lens.createAreas();
                        lens.createLayers();
                        lens.setBounds(lens.areaQuery.getBounds());
                    }
                },
                mouseout:function(){
                    console.log("Bellow is the attLensesArray");
                    console.log(attLensesArray);
                    outterLensesLayer.removeLayer(lens.outsideCircle);
                }
            });
            lens.areaQuery.on({
                dbclick:function(e){
                    L.DomEvent.stopPropagation(e);
                },
                click: function(e){
                    L.DomEvent.stopPropagation(e);
                    outterLensesLayer.addLayer(lens.outsideCircle);
                    $('.myDeleteButton').click(function (e) {
                        L.DomEvent.stopPropagation(e); 
                        outterLensesLayer.removeLayer(lens.outsideCircle);
                        lensesLayer.removeLayer(lens.areaQuery);
                        lens.delete();
                        lens.updateOthersV2(true);
                    });
                    $('.myRadiusButton').click(function (e) {
                        L.DomEvent.stopPropagation(e); 
                        if(document.getElementById("rotationSliderContainer").style.display=='none'){
                            $(function(){
                                var $container = $('#rotationSliderContainer');
                                var $slider = $('#rotationSlider');
                                var $degrees = $('#rotationSliderDegrees');
                                
                                    document.getElementById("rotationSliderContainer").style.display="block";
                                    document.getElementById("rotationSlider").style.display="block";
                                    document.getElementById("rotationSliderDegrees").style.display="block";

                                    
                                    var sliderWidth = $slider.width();
                                    var sliderHeight = $slider.height();
                                    var radius = $container.width()/2;
                                    var deg = 0; 

                                    deg = lens.getRadius()*360/10000;  
                                    
                                    X = Math.round(radius* Math.sin(deg*Math.PI/180));
                                    Y = Math.round(radius*  -Math.cos(deg*Math.PI/180));
                                    $slider.css({ left: X+radius-sliderWidth/2, top: Y+radius-sliderHeight/2 });
                                    
                                    var mdown = false;
                                    $container
                                    //.mousedown(function (e) {e.originalEvent.preventDefault();});
                                    .mousedown(function (e) {
                                        L.DomEvent.stopPropagation(e);
                                        mdown = true; e.originalEvent.preventDefault();
                                        map.dragging.disable(); 
                                        
                                        
                                    })
                                    .mouseup(function (e) { 
                                        L.DomEvent.stopPropagation(e);
                                        mdown = false;
                                        map.dragging.enable();
                                        if (moved){
                                            moved = false;
                                            lens.createAreas();
                                            lens.createLayers();
                                            lens.setBounds(lens.areaQuery.getBounds());
                                        }
                                    })
                                    .mousemove(function (e) {

                                        if(mdown)
                                        {
                                            if(!(moved)){
                                                lens.updateOthersV2(true);
                                                lens.delete();
                                            }
                                            moved = true;      
                                            e.originalEvent.preventDefault();
                                            L.DomEvent.stopPropagation(e);
                                            // firefox compatibility
                                            if(typeof e.offsetX === "undefined" || typeof e.offsetY === "undefined") {
                                            var targetOffset = $(e.target).offset();
                                            e.offsetX = e.pageX - targetOffset.left;
                                            e.offsetY = e.pageY - targetOffset.top;
                                            }
                                            
                                            if($(e.target).is('#rotationSliderContainer'))
                                                var mPos = {x: e.offsetX, y: e.offsetY};
                                            else
                                                var mPos = {x: e.target.offsetLeft + e.offsetX, y: e.target.offsetTop + e.offsetY};
                                                
                                            var atan = Math.atan2(mPos.x-radius, mPos.y-radius);
                                            deg = -atan/(Math.PI/180) + 180; // final (0-360 positive) degrees from mouse position 
                                            
                                            
                                            // for attraction to multiple of 90 degrees
                                            var distance = Math.abs( deg - ( Math.round(deg / 90) * 90 ) );
                                            
                                            if( distance <= 5 )
                                                deg = Math.round(deg / 90) * 90;
                                                
                                            if(deg == 360)
                                                deg = 0;
                                            
                                            X = Math.round(radius* Math.sin(deg*Math.PI/180));
                                            Y = Math.round(radius*  -Math.cos(deg*Math.PI/180));

                                            $slider.css({ left: X+radius-sliderWidth/2, top: Y+radius-sliderHeight/2 });              
                                            
                                            var roundDeg = Math.round(deg);
                                            
                                            var percentage = deg/360;

                                            var radiusMet = Math.round(10000 * percentage);
                                            lens.setRadius(radiusMet); 
                                            $degrees.html(radiusMet + 'Meters');
                                            //$('#imageRotateDegrees').val(radiusMet);
                                        }
                                     });      
                                    });            
                                
                                
                            }
                            else{
                                document.getElementById("rotationSliderContainer").style.display="none";
                                document.getElementById("rotationSlider").style.display="none";
                                document.getElementById("rotationSliderDegrees").style.display="none";
                            }

                    }); 
                    
                    $('.dropbtnOpt-length').click(function () {
                            //lens.updateOthers();
                            lens.updateLENS(true,"length");
                    });
                    $('.dropbtnOpt-velocity').click(function () {
                            //lens.updateOthers();
                            lens.updateLENS(true,"vel");
                    });
                    $('.dropbtnOpt-time').click(function () {
                            //lens.updateOthers();
                            //lens.att = "time"
                            lens.updateLENS(true,"time");
                    });
                    $('.dropbtnOpt-duration').click(function () {
                            //lens.updateOthers();
                            //lens.att = "duration"
                            lens.updateLENS(true,"duration");
                    });

                    $('.dropbtnOpt-color').click(function () {
                            //lens.updateOthers();
                            //lens.enc = "color"
                            lens.updateLENS(false,"color");
                    });
                    $('.dropbtnOpt-width').click(function () {
                            //lens.updateOthers();
                            //lens.enc = "width"
                            lens.updateLENS(false,"width");
                    });
                    $('.dropbtnOpt-brightness').click(function () {
                            //lens.updateOthers();
                            //lens.enc = "brightness"
                            lens.updateLENS(false,"brightness");
                    });
                    $('.dropbtnOpt-opacity').click(function () {
                            //lens.updateOthers();
                            //lens.enc = "opacity"
                            lens.updateLENS(false,"opacity");
                    });   
 
                }
            }); 
            
            return lens
        }

        function creaAttAreas(areaOfQuery){
            var areaObj = {
                area:areaOfQuery,
                lensArray: [],
                lID:null,
                setArea: function(newValue){
                    this.area = newValue;
                },
                addLens: function (obj){
                    this.lensArray.push(obj);
                },
                removeLens: function (obj){
                    for(var i = this.lensArray.length - 1; i >= 0; i--) {
                        if(this.lensArray[i] === obj) {
                            this.lensArray.splice(i, 1);
                            return true;
                        }
                    }
                    return false;
                },
                setlID : function(value){
                    this.lID = value;
                },
                getlID : function(){
                    return this.lID;
                },
                getLensArray : function(){
                    return this.lensArray;
                },
                createLayers : function(){
                    var attLayer = L.featureGroup({pane: 'attLensPane'}).addTo(attLenResults);
                    var _attLayer = L.featureGroup({pane: 'attLensPane'}).addTo(attLayer);
                    var _attLayer1 = L.featureGroup({pane: 'attLensPane'}).addTo(attLayer);
                    var _attLayer2 = L.featureGroup({pane: 'attLensPane'}).addTo(attLayer);
                    var _attLayer3 = L.featureGroup({pane: 'attLensPane'}).addTo(attLayer);
                    

                        // Create URL
                    var urlString3 = "attQueryNEW/trajectory_lines/"  + JSON.stringify(this.area.geometry);
                    var urlString2 = "attQueryNEW/trajectory_lines1/" + JSON.stringify(this.area.geometry);
                    var urlString1 = "attQueryNEW/trajectory_lines2/" + JSON.stringify(this.area.geometry);
                    var urlString  = "attQueryNEW/trajectory_lines3/" + JSON.stringify(this.area.geometry);
                    
                    this.setlID(attLayer._leaflet_id);
                    var thisVar = this;
                    var newData = $.ajax({
                        url: urlString,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("Data successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    }) 
                    $.when(newData).done(function() {
                        
                        if(newData.responseJSON.features != null){
                            newData.responseJSON.features.forEach(function(item, index, array) {
                                var tracksToDraw = L.geoJson(item,firstStyleATT);
                                thisVar.getLensArray().forEach(function(lens,index,array){
                                    console.log(lens);
                                    lens.updateLayer(tracksToDraw,item.properties);
                                });
                                tracksToDraw.addTo(_attLayer);
                            });
                            
                        }
                    }); 
                    var newData1 = $.ajax({
                        url: urlString1,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("Data successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    }) 
                    $.when(newData1).done(function() {
                        if(newData1.responseJSON.features != null){
                            newData1.responseJSON.features.forEach(function(item, index, array) {
                                var tracksToDraw = L.geoJson(item,firstStyleATT);
                                thisVar.getLensArray().forEach(function(lens,index,array){
                                    lens.updateLayer(tracksToDraw,item.properties);
                                });
                                tracksToDraw.addTo(_attLayer1);
                            });
                            
                        }
                    });
                    var newData2 = $.ajax({
                        url: urlString2,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("Data successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    }) 
                    $.when(newData2).done(function() {
                        if(newData2.responseJSON.features != null){
                            newData2.responseJSON.features.forEach(function(item, index, array) {
                                var tracksToDraw = L.geoJson(item,firstStyleATT);
                                thisVar.getLensArray().forEach(function(lens,index,array){
                                    lens.updateLayer(tracksToDraw,item.properties); 
                                });
                                tracksToDraw.addTo(_attLayer2);
                            });
                            
                        }
                    });
                    var newData3 = $.ajax({
                        url: urlString3,
                        type: 'GET',
                        dataType:'json',
                        success: console.log("Data successfully loaded!"),
                        error: function (xhr) {
                            alert(xhr.statusText)
                        }
                        
                    }) 
                    $.when(newData3).done(function() {
                        if(newData3.responseJSON.features != null){
                            newData3.responseJSON.features.forEach(function(item, index, array) {
                                var tracksToDraw = L.geoJson(item,firstStyleATT);
                                thisVar.getLensArray().forEach(function(lens,index,array){
                                    lens.updateLayer(tracksToDraw,item.properties); 
                                });
                                tracksToDraw.addTo(_attLayer3);
                            });
                            
                            
                        }
                    });
                    
                },
                updateLayer : function(){
                    var thisVar = this;
                    attLenResults.getLayer(this.getlID()).eachLayer(function(oneOfFourATTLayers){
                        oneOfFourATTLayers.eachLayer(function(oneOfSmallLayerContainer){
                            oneOfSmallLayerContainer.eachLayer(function(oneOfSmallLayers) {
                                oneOfSmallLayers.setStyle(firstStyleATT);
                                thisVar.getLensArray().forEach(function(lens,index,array){
                                    lens.updateLayer(oneOfSmallLayers,oneOfSmallLayers.feature.properties);
                                });
                            });
                        });
                    });
                },
                delete : function(){
                    attLenResults.removeLayer(this.getlID());
                    this.setlID(null);
                }


            };
            return areaObj;
        }

        /////
        /////
        /////

        /////
        /////  Functions per attribute
        /////

        function velocityAtt(layer, properties, encoding){
             // code block
            var velAtt = properties.f5;
            switch(encoding){
                case "color":
                    /*layer.setStyle({opacity:0});
                    var pointsArray = layer.feature.geometry.coordinates;
                    
                    var velArray =  layer.feature.properties.f5;

                    var finalArray = [];
                    
                    for(var i = 0;i < velArray.length;i++ ){
                        finalArray.push([pointsArray[i][1],pointsArray[i][0],velArray[i]]);    
                    }
                    console.log(pointsArray);
                    var hotlineLayer = L.hotline(finalArray, {
                        min: 0,
                        max: 60,
                        palette: {
                            0.0: '#ff0000',
                            0.3: '#ffff00',
                            1.0: '#008800'
                        },
                        weight: 1,
                        outlineColor: '#FFFFFF',
                        outlineWidth: 0
                    });
                    
                    delete finalArray;
                    delete pointsArray;
                    delete velArray;
                    

                    console.log(hotlineLayer);
                    hotlineLayer.addTo(layerToPaint);
                    */

                    if(velAtt <= 1)          {
                            layer.setStyle({color :'#29FF9A'});
                    }
                    else if(velAtt <= 2)     {
                            layer.setStyle({color :'#40E49B'});
                    }
                    else if(velAtt <= 5)    {
                            layer.setStyle({color :'#58CA9C'});
                    }
                    else if(velAtt <= 10)    {
                            layer.setStyle({color :'#70B09D'});
                    }
                    else if(velAtt <= 15)    {
                            layer.setStyle({color :'#88969E'});
                    }
                    else if(velAtt <= 20)    {
                            layer.setStyle({color :'#9F7C9F'});
                    }
                    else if(velAtt <=  30)   {
                            layer.setStyle({color :'#B762A0'});
                    }
                    else if(velAtt <=  50)   {
                            layer.setStyle({color :'#CF48A1'});
                    }
                    else if(velAtt <=  80)   {
                            layer.setStyle({color :'#E72EA2'});
                    }
                    else    layer.setStyle({color :'#FF14A3'});
                    break;
                    
                    break;
                case "brightness":
                    if(velAtt <= 1)          {
                        var colr = ColorLuminance(layer.options.color,-0.95);
                        layer.setStyle({"color":colr});
                    }
                    else if(velAtt <= 2)     {
                        var colr = ColorLuminance(layer.options.color,-0.9);
                        layer.setStyle({"color":colr});
                    }
                    else if(velAtt <= 5)    {
                        var colr = ColorLuminance(layer.options.color,-0.8);
                        layer.setStyle({"color":colr});
                    }
                    else if(velAtt <= 10)    {
                        var colr = ColorLuminance(layer.options.color,-0.65);
                        layer.setStyle({"color":colr});
                    }
                    else if(velAtt <= 15)    {
                        var colr = ColorLuminance(layer.options.color,-0.5);
                        layer.setStyle({"color":colr});
                    }
                    else if(velAtt <= 20)    {
                        var colr = ColorLuminance(layer.options.color,-0.35);
                        layer.setStyle({"color":colr});
                    }
                    else if(velAtt <=  30)   {
                        var colr = ColorLuminance(layer.options.color,-0.2);
                        layer.setStyle({"color":colr});
                    }
                    else if(velAtt <=  50)   {
                        var colr = ColorLuminance(layer.options.color,-0.1);
                        layer.setStyle({"color":colr});
                    }
                    else if(velAtt <=  80)   {
                        var colr = ColorLuminance(layer.options.color,-0.05);
                        layer.setStyle({"color":colr});
                    }
                    else                    console.log("brightness already at 1")
                    break;
                case "opacity":
                
                    break;
                case "width":
                
                    break;
            }
        }

        function lengthAtt(layer,properties, encoding){
             // code block
            var len = properties.f1;
            switch(encoding){
                case "color":
                    if(len <= 250)          layer.setStyle({color :'#29FF9A'}) 
                    else if(len <= 500)     layer.setStyle({color :'#40E49B'})
                    else if(len <= 1000)    layer.setStyle({color :'#58CA9C'}) 
                    else if(len <= 2000)    layer.setStyle({color :'#70B09D'})
                    else if(len <= 4000)    layer.setStyle({color :'#88969E'}) 
                    else if(len <= 8000)    layer.setStyle({color :'#9F7C9F'}) 
                    else if(len <= 16000)   layer.setStyle({color :'#B762A0'})
                    else if(len <= 32000)   layer.setStyle({color :'#CF48A1'})
                    else if (len <= 128000) layer.setStyle({color :'#E72EA2'})
                    else                    layer.setStyle({color :'#FF14A3'})
                    break;
                case "brightness":
                    if(len <= 250)          {
                        var colr = ColorLuminance(layer.options.color,-0.95);
                        layer.setStyle({"color":colr});
                    }
                    else if(len <= 500)     {
                        var colr = ColorLuminance(layer.options.color,-0.9);
                        layer.setStyle({"color":colr});
                    }
                    else if(len <= 1000)    {
                        var colr = ColorLuminance(layer.options.color,-0.8);
                        layer.setStyle({"color":colr});
                    }
                    else if(len <= 2000)    {
                        var colr = ColorLuminance(layer.options.color,-0.65);
                        layer.setStyle({"color":colr});
                    }
                    else if(len <= 4000)    {
                        var colr = ColorLuminance(layer.options.color,-0.5);
                        layer.setStyle({"color":colr});
                    }
                    else if(len <= 8000)    {
                        var colr = ColorLuminance(layer.options.color,-0.35);
                        layer.setStyle({"color":colr});
                    }
                    else if(len <=  16000)   {
                        var colr = ColorLuminance(layer.options.color,-0.2);
                        layer.setStyle({"color":colr});
                    }
                    else if(len <=  32000)   {
                        var colr = ColorLuminance(layer.options.color,-0.1);
                        layer.setStyle({"color":colr});
                    }
                    else if(len <=  128000)   {
                        var colr = ColorLuminance(layer.options.color,-0.05);
                        layer.setStyle({"color":colr});
                    }
                    else                    console.log("brightness already at 1")
                    break;
                case "opacity":
                    if(len <= 250)          layer.setStyle({opacity:0.05});
                    else if(len <= 500)     layer.setStyle({opacity:0.10});
                    else if(len <= 1000)    layer.setStyle({opacity:0.20}); 
                    else if(len <= 2000)    layer.setStyle({opacity:0.35});
                    else if(len <= 4000)    layer.setStyle({opacity:0.5});
                    else if(len <= 8000)    layer.setStyle({opacity:0.65});
                    else if(len <= 16000)   layer.setStyle({opacity:0.8});
                    else if(len <= 32000)   layer.setStyle({opacity:0.9});
                    else if(len <= 128000)  layer.setStyle({opacity:0.95});
                    else                    console.log("Opcacity already at 1")
                    break;
                case "width":
                if(len <= 250)              layer.setStyle({"weight": 0.1});
                    else if(len <= 500)     layer.setStyle({"weight": 0.5});
                    else if(len <= 1000)    layer.setStyle({"weight": 1});
                    else if(len <= 2000)    layer.setStyle({"weight": 1.5});
                    else if(len <= 4000)    layer.setStyle({"weight": 2});
                    else if(len <= 8000)    layer.setStyle({"weight": 2.5});
                    else if(len <= 16000)   layer.setStyle({"weight": 3.5});
                    else if(len <= 32000)   layer.setStyle({"weight": 5});
                    else if(len <= 128000)  layer.setStyle({"weight": 6.5});
                    else                    layer.setStyle({"weight": 8});
                    break;
            }
        }
        
        function durationAtt(layer, properties, encoding){
             // code block
            var dur = properties.f2;
            switch(encoding){
                case "color":
                    if(dur <= "00:01:00")           layer.setStyle({color :'#FFF8DC'}) 
                    else if(dur <= "00:02:00")      layer.setStyle({color :'#FFE4C4'}) 
                    else if(dur <= "00:05:00")      layer.setStyle({color :'#F5DEB3'})
                    else if(dur <= "00:010:00")     layer.setStyle({color :'#DAA520'}) 
                    else if(dur <=  "00:30:00")     layer.setStyle({color :'#D2691E'}) 
                    else                            layer.setStyle({color :'#A52A2A'}) 
                    break;
                case "brightness":
                    if(dur <= "00:01:00")          {
                        var colr = ColorLuminance(layer.options.color,-0.95);
                        layer.setStyle({"color":colr});
                    }
                    else if(dur <= "00:02:00")     {
                        var colr = ColorLuminance(layer.options.color,-0.9);
                        layer.setStyle({"color":colr});
                    }
                    else if(dur <= "00:05:00")    {
                        var colr = ColorLuminance(layer.options.color,-0.8);
                        layer.setStyle({"color":colr});
                    }
                    else if(dur <= "00:10:00")    {
                        var colr = ColorLuminance(layer.options.color,-0.5);
                        layer.setStyle({"color":colr});
                    }
                    else if(dur <=  "00:30:00")   {
                        var colr = ColorLuminance(layer.options.color,-0.2);
                        layer.setStyle({"color":colr});
                    }
                    else                    console.log("brightness already at 1")
                    break;
                case "opacity":
                    if(dur <= "00:01:00")           layer.setStyle({opacity:0.05});
                    else if(dur <= "00:02:00")      layer.setStyle({opacity:0.15}); 
                    else if(dur <= "00:05:00")      layer.setStyle({opacity:0.3});
                    else if(dur <= "00:10:00")      layer.setStyle({opacity:0.55});
                    else if(dur <=  "00:30:00")     layer.setStyle({opacity:0.8});
                    else                            console.log("Opcacity already at 1")
                    break;
                case "width":
                    if(dur <= "00:01:00")           layer.setStyle({"weight": 0.2});
                    else if(dur <= "00:02:00")      layer.setStyle({"weight": 0.8});
                    else if(dur <= "00:05:00")      layer.setStyle({"weight": 1.5});
                    else if(dur <= "00:10:00")      layer.setStyle({"weight": 2.5});
                    else if(dur <=  "00:30:00")     layer.setStyle({"weight": 3.5});
                    else                            layer.setStyle({"weight": 5});
                    break;
            }
        }

         function timeAtt(layer, properties, encoding){
            // 2008-02-02 13:30:44
            // 2008-02-08 17:39:18
            // code block
            var tim = properties.f3;
            switch(encoding){
                case "color":
                    if(tim <= "2008-02-03 13:30:44")            layer.setStyle({color :'#FFF8DC'}) 
                    else if(tim <= "2008-02-04 13:30:44")       layer.setStyle({color :'#FFE4C4'}) 
                    else if(tim <= "2008-02-05 13:30:44")       layer.setStyle({color :'#F5DEB3'})
                    else if(tim <= "2008-02-06 13:30:44")       layer.setStyle({color :'#DAA520'}) 
                    else if(tim <=  "2008-02-07 13:30:44")      layer.setStyle({color :'#D2691E'}) 
                    else                                        layer.setStyle({color :'#A52A2A'}) 
                    break;
                case "brightness":
                    if(tim <= "2008-02-03 13:30:44")          {
                        var colr = ColorLuminance(layer.options.color,-0.95);
                        layer.setStyle({"color":colr});
                    }
                    else if(tim <= "2008-02-04 13:30:44")     {
                        var colr = ColorLuminance(layer.options.color,-0.9);
                        layer.setStyle({"color":colr});
                    }
                    else if(tim <= "2008-02-05 13:30:44")    {
                        var colr = ColorLuminance(layer.options.color,-0.8);
                        layer.setStyle({"color":colr});
                    }
                    else if(tim <= "2008-02-06 13:30:44")    {
                        var colr = ColorLuminance(layer.options.color,-0.5);
                        layer.setStyle({"color":colr});
                    }
                    else if(tim <= "2008-02-07 13:30:44")   {
                        var colr = ColorLuminance(layer.options.color,-0.2);
                        layer.setStyle({"color":colr});
                    }
                    else                    console.log("brightness already at 1")
                    break;
                case "opacity":
                    if(tim <= "2008-02-03 13:30:44")            layer.setStyle({opacity:0.05});
                    else if(tim <= "2008-02-04 13:30:44")       layer.setStyle({opacity:0.15}); 
                    else if(tim <= "2008-02-05 13:30:44")       layer.setStyle({opacity:0.3});
                    else if(tim <= "2008-02-06 13:30:44")       layer.setStyle({opacity:0.55});
                    else if(tim <= "2008-02-07 13:30:44")       layer.setStyle({opacity:0.8});
                    else                                        console.log("Opcacity already at 1")
                    break;
                case "width":
                    if(tim <= "2008-02-03 13:30:44")            layer.setStyle({"weight": 0.2});
                    else if(tim <= "2008-02-04 13:30:44")       layer.setStyle({"weight": 0.8});
                    else if(tim <= "2008-02-05 13:30:44")       layer.setStyle({"weight": 1.5});
                    else if(tim <= "2008-02-06 13:30:44")       layer.setStyle({"weight": 2.5});
                    else if(tim <= "2008-02-07 13:30:44")       layer.setStyle({"weight": 3.5});
                    else                                        layer.setStyle({"weight": 5});
                    break;
            }
        }
        /////
        /////
        /////


        /////
        ///// support
        /////

        function Unix_timestamp(t){
            var dt = new Date(t);
            var stringDate = dt.toUTCString();
            /*var year = dt.getFullYear();
            var month = dt.getMonth();
            var day = dt.getDay();
            var hour = dt.getHours();
            var minute = dt.getMinutes();
            var seconds = dt.getSeconds();*/

            return stringDate;
        }

        function ColorLuminance(hex, lum) {

            // validate hex string
            hex = String(hex).replace(/[^0-9a-f]/gi, '');
            if (hex.length < 6) {
                hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
            }
            lum = lum || 0;

            // convert to decimal and change luminosity
            var rgb = "#", c, i;
            for (i = 0; i < 3; i++) {
                c = parseInt(hex.substr(i*2,2), 16);
                c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
                rgb += ("00"+c).substr(c.length);
            }

            return rgb;
        }

        


